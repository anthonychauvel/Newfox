<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="/hs/manifest.json">
<link rel="apple-touch-icon" href="/hs/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Compteur Heures & Paie">
<meta name="theme-color" content="#4FB3C2">
<meta charset="UTF-8">
<title>Simulateur de compteur annuel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.kitsune-btn{flex:1;padding:8px 16px;border-radius:20px;border:none;background:linear-gradient(135deg,#4FB3C2,#2196a6);color:#fff;font-size:14px;font-weight:500;cursor:pointer;box-shadow:0 2px 8px rgba(79,179,194,.35);transition:transform .15s,box-shadow .15s}
.kitsune-btn:hover{transform:scale(1.02);box-shadow:0 4px 16px rgba(79,179,194,.55)}
.kitsune-btn:active{transform:scale(.97)}
.top-nav-bar{display:flex;gap:8px;margin-top:8px;margin-bottom:20px}
.top-nav-bar .menu-btn{flex:1;margin:0}
.menu-btn{margin-top:8px;margin-bottom:20px;padding:8px 16px;border-radius:20px;border:none;background:rgba(255,255,255,.85);font-size:14px;font-weight:500;cursor:pointer}
.month-nav{display:flex;gap:10px;margin-bottom:10px;width:100%}
.month-nav select{flex:1;min-height:40px;display:block;width:100%;box-sizing:border-box;background-color:#fff;-webkit-appearance:menulist;border:1px solid #ccc;border-radius:4px}
.calc-details summary{cursor:pointer;font-weight:bold;background:#e3f2fd;padding:8px;border-radius:6px;margin-bottom:8px}
.calc-details[open] summary{background:#bbdefb}
body{font-family:Arial,sans-serif;background:#f2f2f2;padding:15px}
h1,h2{text-align:center}
.config,.totaux{background:#fff;padding:15px;border-radius:8px;max-width:900px;margin:15px auto}
.calendar-wrapper{max-width:900px;margin:20px auto}
.weekdays,.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.weekday{text-align:center;font-weight:bold;background:#ddd;padding:8px 0;border-radius:6px}
.day{background:#fff;padding:6px;border-radius:6px;cursor:pointer;text-align:center;height:80px;box-sizing:border-box;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between}
.day small{font-size:11px;line-height:1.1;white-space:nowrap}
.day.in-period{border:2px solid #2196a6;background:#e0f4f7}
button,input,textarea{width:100%;padding:8px;margin:5px 0}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-end;justify-content:center;z-index:1000;pointer-events:auto;will-change:transform;transform:translateZ(0);backface-visibility:hidden}
.popup-content{background:#fff;width:100%;max-width:500px;max-height:70svh;overflow-y:auto;border-radius:16px 16px 0 0;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom));-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.breakdown{background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;font-size:14px}
.day.today{outline:3px solid #2196a6;box-shadow:0 0 6px rgba(33,150,166,.6)}
.sheet-handle{width:40px;height:4px;background:#ccc;border-radius:2px;margin:6px auto 10px}
.block{border:none;margin-bottom:16px}
.block.plus legend{color:#1976d2}
.block.minus legend{color:#ef6c00}
.block.absence legend{color:#c62828}
.popup-actions{position:sticky;bottom:env(safe-area-inset-bottom);background:#fff;padding-top:10px}
#openSettingsBtn{display:block;width:calc(100% - 30px);max-width:900px;margin:0 auto 20px;padding:13px 20px;background:linear-gradient(135deg,#37474f,#546e7a);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 2px 10px rgba(55,71,79,.3);transition:transform .15s,box-shadow .15s;text-align:left}
#openSettingsBtn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(55,71,79,.45)}
#openSettingsBtn:active{transform:scale(.98)}
#settingsModal .popup-content{max-width:600px;max-height:70svh;overflow-y:auto;border-radius:16px 16px 0 0;padding-bottom:calc(16px + env(safe-area-inset-bottom))}
.settings-group{margin-bottom:18px}
.settings-group-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#888;margin-bottom:8px;display:block}
.settings-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.settings-row button,.settings-row input,.settings-row select{flex:1;min-width:120px;margin:0}
.settings-divider{border:none;border-top:1px solid #eee;margin:16px 0}
.settings-danger-btn{background:#ffcdd2;color:#b71c1c;font-weight:bold;border:1px solid #ef9a9a;border-radius:8px;padding:8px;cursor:pointer;width:100%}
.settings-modal-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.settings-modal-title h3{margin:0}
.settings-close-x{background:none;border:none;font-size:22px;cursor:pointer;color:#888;padding:0 4px;line-height:1;width:auto}
#wizardModal .popup-content{max-width:540px;max-height:70svh;overflow-y:auto;border-radius:16px 16px 0 0;padding-bottom:calc(16px + env(safe-area-inset-bottom))}
.wiz-progress{background:#e0e0e0;border-radius:4px;height:6px;margin-bottom:6px;overflow:hidden}
.wiz-progress-bar{height:100%;background:linear-gradient(90deg,#4FB3C2,#2196a6);border-radius:4px;transition:width .4s ease}
.wiz-step-label{font-size:11px;color:#aaa;margin-bottom:20px;display:block}
.wiz-step{display:none}
.wiz-step.wiz-active{display:block}
.wiz-question{font-size:18px;font-weight:700;color:#2c3e50;margin-bottom:18px;line-height:1.4}
.wiz-hint{font-size:13px;color:#888;margin-top:-10px;margin-bottom:14px}
.wiz-choice-row{display:flex;gap:10px;margin-bottom:16px}
.wiz-choice-btn{flex:1;padding:14px 10px;border-radius:12px;border:2px solid #e0e0e0;background:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;line-height:1.4}
.wiz-choice-btn:hover,.wiz-choice-btn.wiz-selected{border-color:#4FB3C2;background:#e0f4f7;color:#2196a6}
.wiz-nav{display:flex;gap:10px;margin-top:20px;background:#fff;padding-top:10px;padding-bottom:4px}
.wiz-closures-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.wiz-closures-grid label{font-size:12px;color:#666;margin-bottom:2px;display:block}
.wiz-closures-grid input{margin:0;font-size:13px;padding:6px}
.wiz-check-row{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;background:#f9f9f9;border:1px solid #eee;margin-bottom:10px;cursor:pointer}
.wiz-check-row input[type=checkbox]{width:18px;height:18px;margin:0;flex-shrink:0;cursor:pointer}
.wiz-check-row span{font-size:14px;font-weight:500}
.wiz-summary{background:#f1f8e9;border:1px solid #aed581;border-radius:10px;padding:14px;font-size:13px;line-height:1.8;margin-bottom:16px}
.wiz-summary b{color:#33691e}
</style>
</head>
<body>
<div class="top-nav-bar">
  <button class="menu-btn" onclick="goMenu()">&#8592; Retour au menu</button>
  <button class="kitsune-btn" onclick="window.location.href='../fox/index.html'" title="Ouvrir FOX Engine" style="display:none">&#x1F98A; Kitsune</button>
</div>
<div id="exerciseAlert" style="display:none;max-width:900px;margin:10px auto;background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:12px;border-radius:8px;font-weight:bold;text-align:center;">
  &#9888;&#65039; Action requise : D&eacute;finissez votre date de d&eacute;but d&apos;exercice dans la Configuration pour activer le calendrier.
</div>
<div class="popup" id="popupNotice">
  <div class="popup-content" style="max-width:800px;max-height:80vh;overflow:auto;">
    <h3>&#x1F4D8; Notice utilisateur &ndash; Compteur annuel d&apos;heures</h3>
    <p>Cet outil permet de suivre et d&apos;estimer les heures de travail, les heures suppl&eacute;mentaires, les r&eacute;cup&eacute;rations et les absences dans le cadre d&apos;un <b>compteur annuel</b>.</p>
    <hr><h4>&#x1F5D3;&#65039; Principe g&eacute;n&eacute;ral</h4>
    <p>Le suivi est organis&eacute; par exercice annuel, d&eacute;coup&eacute; en p&eacute;riodes comptables. Les calculs sont r&eacute;alis&eacute;s semaine par semaine, puis cumul&eacute;s sur la p&eacute;riode et sur l&apos;ann&eacute;e.</p>
    <hr><h4>&#x23F1;&#65039; Base hebdomadaire</h4>
    <p>La base hebdomadaire (ex&nbsp;: 35h) repr&eacute;sente une semaine compl&egrave;te th&eacute;orique. Les heures suppl&eacute;mentaires sont d&eacute;clench&eacute;es uniquement apr&egrave;s d&eacute;passement de cette base, d&eacute;duction faite des absences.</p>
    <hr><h4>&#10060; Absences</h4>
    <p>Les absences correspondent &agrave; du temps non travaill&eacute;. Elles <b>r&eacute;duisent le volume d&apos;heures attendues</b> dans la semaine, ce qui diminue le solde brut de la p&eacute;riode. Elles ne g&eacute;n&egrave;rent pas d&apos;heures suppl&eacute;mentaires.</p>
    <hr><h4>&#x1F501; R&eacute;cup&eacute;rations</h4>
    <p>Les r&eacute;cup&eacute;rations sont des heures pr&eacute;c&eacute;demment travaill&eacute;es, reprises ult&eacute;rieurement sous forme de repos.</p>
    <p><b>Dans cet outil, les r&eacute;cup&eacute;rations ne r&eacute;duisent pas la base hebdomadaire.</b> Elles sont uniquement soustraites du <b>solde brut</b> pour obtenir le <b>solde net</b>, afin d&apos;&eacute;viter un double comptage.</p>
    <hr><h4>&#x1F38C; Jours f&eacute;ri&eacute;s</h4>
    <p>Un jour f&eacute;ri&eacute; ch&ocirc;m&eacute; et pay&eacute; r&eacute;duit le volume d&apos;heures attendues (par d&eacute;faut 7h), au m&ecirc;me titre qu&apos;une absence. Il ne modifie pas le seuil de d&eacute;clenchement des heures suppl&eacute;mentaires.</p>
    <hr><h4>&#10133; Heures suppl&eacute;mentaires</h4>
    <p>D&eacute;clench&eacute;es &agrave; partir de la 36&sup1; heure r&eacute;ellement travaill&eacute;e dans la semaine (base 35h, ajust&eacute;e des absences uniquement)&nbsp;:</p>
    <ul><li>36&sup1; &agrave; 43&sup1; heure&nbsp;: majoration de <b>25&nbsp;%</b></li><li>Au-del&agrave; de la 43&sup1; heure&nbsp;: majoration de <b>50&nbsp;%</b></li></ul>
    <hr><h4>&#x1F4C6; P&eacute;riodes et cl&ocirc;tures</h4>
    <p>Les p&eacute;riodes se terminent le dimanche. La p&eacute;riode suivante d&eacute;bute automatiquement le lundi. Le solde d&apos;une p&eacute;riode est automatiquement report&eacute; sur la p&eacute;riode suivante.</p>
    <hr><h4>&#x1F512; Verrouillage de la configuration</h4>
    <p>Il est possible de verrouiller les param&egrave;tres g&eacute;n&eacute;raux (date de d&eacute;but, base hebdomadaire, cl&ocirc;ture annuelle) afin d&apos;&eacute;viter toute modification involontaire.</p>
    <hr><h4>&#x1F4BE; Sauvegarde</h4>
    <p>Les donn&eacute;es sont enregistr&eacute;es localement sur l&apos;appareil utilis&eacute;. Il est fortement recommand&eacute; d&apos;effectuer des exports r&eacute;guliers (mensuels ou apr&egrave;s chaque cl&ocirc;ture) pour s&eacute;curiser le suivi annuel.</p>
    <hr><p style="font-size:12px;color:#777">Cette notice est fournie &agrave; titre informatif. L&apos;outil ne constitue pas un logiciel de paie et ne se substitue pas aux documents officiels de l&apos;employeur.</p>
    <button onclick="closeNotice()">Fermer</button>
  </div>
</div>
<h1>Compteur Heures Sup</h1>
<p style="text-align:center"></p>
<p style="text-align:center">Exercice&nbsp;: <b id="activeYearLabel"></b> <button onclick="switchYear()">&#128193; Changer</button></p>
<button id="openSettingsBtn" onclick="openSettingsModal()">&#9881;&#65039; Configuration &amp; R&eacute;glages <span style="float:right;opacity:.6;font-weight:400;font-size:13px">Appuyer pour ouvrir &rsaquo;</span></button>
<div class="popup" id="settingsModal">
  <div class="popup-content">
    <div class="settings-modal-title"><h3>&#9881;&#65039; Configuration</h3><button class="settings-close-x" onclick="closeSettingsModal()">&#10005;</button></div>
    <div class="settings-group">
      <span class="settings-group-label">&#128197; Exercice &amp; Calendrier</span>
      <label style="font-size:13px;margin-bottom:4px;display:block;">Date de d&eacute;but d&apos;exercice</label>
      <input type="date" id="exerciseStartInput">
      <label style="font-size:13px;margin-top:8px;margin-bottom:4px;display:block;">Date de cl&ocirc;ture annuelle</label>
      <input type="date" id="annualDateInput">
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label">&#x23F1;&#65039; Temps de travail</span>
      <label style="font-size:13px;margin-bottom:4px;display:block;">Base hebdomadaire (heures)</label>
      <input type="number" step="0.5" id="baseHebdoInput">
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label">&#128198; Cl&ocirc;tures comptables</span>
      <div class="settings-row">
        <button onclick="openClosures()">&#128197; G&eacute;rer les cl&ocirc;tures</button>
        <select id="periodSelect" style="min-width:0"></select>
      </div>
      <p id="periodInfo" style="font-size:13px;color:#555;margin:6px 0 0;"></p>
      <div id="rateContainer"></div>
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label">&#x1F38C; Jours f&eacute;ri&eacute;s</span>
      <button onclick="importFeries()">&#x1F1EB;&#x1F1F7; Importer jours f&eacute;ri&eacute;s officiels</button>
      <label style="display:flex;align-items:center;gap:8px;margin-top:10px;font-size:14px;cursor:pointer;">
        <input type="checkbox" id="autoFerieToggle" style="width:auto;margin:0;">
        Mode f&eacute;ri&eacute; automatique (&minus;7h en semaine)
      </label>
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label">&#x1F4BE; Import / Export</span>
      <div class="settings-row">
        <button onclick="importJSON()">&#x2B06;&#65039; Importer (.json)</button>
        <button onclick="exportJSON()">&#x1F4BE; Sauvegarder</button>
      </div>
      <div class="settings-row" style="margin-top:8px;">
        <button onclick="exportPeriodPDF()">&#x1F4D8; PDF P&eacute;riode</button>
        <button onclick="exportMonthlyFullPDF()">&#x1F4C4; PDF Mensuel</button>
        <button onclick="exportAnnualPDF()">&#x1F4D5; PDF Annuel</button>
      </div>
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label">&#x1F512; S&eacute;curit&eacute;</span>
      <button onclick="toggleConfigLock()">&#x1F512; / &#x1F513; Verrouiller la configuration</button>
      <p id="configLockInfo" style="font-size:13px;color:#555;margin:6px 0 0;"></p>
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label">&#x1F9D9; Assistant de configuration</span>
      <button class="kitsune-btn" style="width:100%;" onclick="restartWizard()">&#x1F9D9; Relancer l&apos;assistant de d&eacute;marrage</button>
    </div>
    <hr class="settings-divider">
    <div class="settings-group">
      <span class="settings-group-label" style="color:#c62828;">&#9888;&#65039; Zone de danger</span>
      <button class="settings-danger-btn" onclick="resetCurrentExercise()">&#x267B;&#65039; R&eacute;initialiser l&apos;exercice en cours</button>
    </div>
    <div class="popup-actions"><button onclick="closeSettingsModal()">Fermer</button></div>
  </div>
</div>
<div id="activePeriodBanner" style="max-width:900px;margin:10px auto;background:#e3f2fd;border:1px solid #90caf9;padding:8px 12px;border-radius:8px;font-size:14px;font-weight:bold;"></div>
<div class="calendar-wrapper main-zone">
  <div class="month-nav">
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
  </div>
  <div class="weekdays">
    <div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div>
    <div class="weekday">Jeu</div><div class="weekday">Ven</div><div class="weekday">Sam</div><div class="weekday">Dim</div>
  </div>
  <div class="calendar" id="calendar"></div>
</div>
<div style="max-width:900px;margin:15px auto;display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;">
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <button onclick="exportJSON()" style="background:#e0f4f7;border:1px solid #2196a6;font-weight:bold;">&#x1F4BE; Sauvegarde dans un fichier</button>
  </div>
  <div id="saveBadges" style="font-size:13px;color:#2196a6;margin-top:6px;width:100%;">
    <span id="autoSaveBadge">&#x1F7E2; Dans l&apos;application&nbsp;: &mdash;</span><br>
    <span id="fileSaveBadge">&#x1F4BE; Sauvegarde fichier&nbsp;: &mdash;</span>
  </div>
  <span style="font-size:13px;color:#2196a6;align-self:center;">Sauvegarde automatique dans l&apos;application &middot; Sauvegarde fichier recommand&eacute;e</span>
</div>
<div class="totaux main-zone" id="totaux"></div>
<div class="popup" id="popup">
  <div class="popup-content">
    <div class="sheet-handle"></div>
    <h3 id="popupDate"></h3>
    <fieldset class="block plus">
      <legend>&#10133; Heures suppl&eacute;mentaires</legend>
      <button onclick="addExtra(0.25)">+15 min</button>
      <button onclick="addExtra(0.5)">+30 min</button>
      <button onclick="addExtra(1)">+1 h</button>
      <button onclick="addExtra(2)">+2 h</button>
      <input id="manualExtra" type="number" step="0.25">
    </fieldset>
    <fieldset class="block minus">
      <legend>&#10134; R&eacute;cup&eacute;ration</legend>
      <button onclick="addRecup(0.25)">-15 min</button>
      <button onclick="addRecup(0.5)">-30 min</button>
      <button onclick="addRecup(1)">-1 h</button>
      <input id="manualRecup" type="number" step="0.25">
    </fieldset>
    <fieldset class="block absence">
      <legend>&#10060; Absence</legend>
      <label><input type="checkbox" id="isAbsent"> Jour d&apos;absence</label>
      <input id="absentHours" type="number" step="0.25">
    </fieldset>
    <div class="popup-actions">
      <button onclick="saveManual()">Valider</button>
      <button onclick="resetDay()" style="background:#c62828;color:#fff">&#x1F5D1;&#65039; Supprimer les heures du jour</button>
      <button onclick="closePopup()">Annuler</button>
    </div>
  </div>
</div>
<div class="popup" id="popupJSON">
  <div class="popup-content">
    <h3 id="jsonTitle"></h3>
    <textarea id="jsonArea" style="width:100%;height:200px"></textarea>
    <button onclick="confirmImportJSON()">Importer</button>
    <button onclick="closeJSONPopup()">Fermer</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let APP_CRASHED=false,RECOVERY_MODE=false,DEBUG_MODE=true;
document.querySelectorAll('.popup').forEach(p=>{p.addEventListener('click',e=>{if(e.target===p&&p.id==="popup")closePopup();});});
let midnightTimer=null;
function enterRecoveryMode(source,error){if(RECOVERY_MODE)return;RECOVERY_MODE=true;APP_CRASHED=true;localStorage.setItem("APP_CRASH_STATE",JSON.stringify({at:new Date().toISOString(),source,message:String(error)}));alert("‚ö†Ô∏è Une erreur est survenue.\n\nL'application est pass√©e en mode r√©cup√©ration.\nAucune donn√©e n'a √©t√© supprim√©e.");}
function simulateCrash(){console.warn("üí• Crash simul√©");undefinedVariable.forceCrash();}
function protectedCrash(){const code=prompt("üîí Zone prot√©g√©e\n\nEntrez le code :");if(code===null)return;if(code==="1234")simulateCrash();else alert("‚ùå Code incorrect");}
function safe(fn,label){return function(...args){try{return fn.apply(this,args);}catch(e){console.error("üí• CRASH:",label,e);enterRecoveryMode(label,e);return undefined;}};}
window.onerror=(msg,src,l,c,err)=>enterRecoveryMode("window.onerror",err||msg);
window.addEventListener("unhandledrejection",e=>enterRecoveryMode("promise",e.reason));
function goMenu(){localStorage.removeItem("lastApp");window.location.href="../menu.html";}
function autoSwitchPeriodAtMidnight(){const now=new Date();const next=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,0,0);if(midnightTimer)clearTimeout(midnightTimer);midnightTimer=setTimeout(()=>{if(typeof buildPeriods==="function")buildPeriods();if(typeof update==="function")update();showToast();autoSwitchPeriodAtMidnight();},next-now);}
let currentSuffix=localStorage.getItem("ACTIVE_YEAR_SUFFIX")||new Date().getFullYear();
document.getElementById("activeYearLabel").textContent=currentSuffix;
function resetCurrentExercise(){if(!confirm("‚ö†Ô∏è R√©initialiser compl√®tement l'exercice "+currentSuffix+" ?\n\nToutes les donn√©es seront supprim√©es."))return;createSnapshot("before_reset_exercise");["DATA_REPORT_","CLOSURES_REPORT_","REPORTS_REPORT_","PERIOD_META_REPORT_","ANNUAL_DATE_","SPECIAL_DAYS_","EXERCISE_START_"].forEach(p=>localStorage.removeItem(p+currentSuffix));alert("‚úÖ Exercice "+currentSuffix+" remis √† z√©ro");location.reload();}
function resetDay(){if(!selectedDate)return;if(!confirm("‚ùå Supprimer toutes les donn√©es de cette journ√©e ?"))return;delete data[selectedDate];save();closePopup();}
function checkExerciseStartAlert(){document.getElementById("exerciseAlert").style.display=exerciseStart?"none":"block";}
function switchYear(){openYearsPopup();}
function openYearsPopup(){const box=document.getElementById("yearsList");if(!box)return;box.innerHTML="";const years=getExistingYears();if(!years.length)box.innerHTML="<i>Aucun exercice existant</i>";else years.forEach(y=>{const btn=document.createElement("button");btn.textContent=y+(String(y)===String(currentSuffix)?" (actif)":"");btn.onclick=()=>{localStorage.setItem("ACTIVE_YEAR_SUFFIX",y);location.reload();};box.appendChild(btn);});document.getElementById("popupYears").style.display="flex";}
function saveManual(){if(!selectedDate)return;if(!data[selectedDate])data[selectedDate]={extra:0,recup:0,absent:0};data[selectedDate].extra=Number(manualExtra.value)||0;data[selectedDate].recup=Number(manualRecup.value)||0;data[selectedDate].absent=isAbsent.checked?(Number(absentHours.value)||DAILY_WORK_HOURS):0;save();closePopup();}
function closeYearsPopup(){document.getElementById("popupYears").style.display="none";}
function confirmSwitchYear(){const val=document.getElementById("newYearInput").value;if(!val)return;if(!localStorage.getItem("DATA_REPORT_"+val)){localStorage.setItem("DATA_REPORT_"+val,JSON.stringify({}));localStorage.setItem("CLOSURES_REPORT_"+val,JSON.stringify([]));localStorage.setItem("REPORTS_REPORT_"+val,JSON.stringify({}));localStorage.setItem("PERIOD_META_REPORT_"+val,JSON.stringify({}));}localStorage.setItem("ACTIVE_YEAR_SUFFIX",val);location.reload();}
function addRecup(h){if(!data[selectedDate])data[selectedDate]={extra:0,recup:0};const nv=Math.round((data[selectedDate].recup+h)*4)/4;data[selectedDate].recup=ALLOW_RECUP_FREE?nv:Math.min(nv,data[selectedDate].extra);save();closePopup();}
function addExtra(h){if(!data[selectedDate])data[selectedDate]={extra:0,recup:0};data[selectedDate].extra=Math.round((data[selectedDate].extra+h)*4)/4;save();closePopup();}
function getExistingYears(){const s=new Set();for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k.startsWith("DATA_REPORT_"))s.add(k.replace("DATA_REPORT_",""));}return Array.from(s).sort();}
const STORAGE={data:"DATA_REPORT_"+currentSuffix,closures:"CLOSURES_REPORT_"+currentSuffix,reports:"REPORTS_REPORT_"+currentSuffix,annualDate:"ANNUAL_DATE_"+currentSuffix,specialDays:"SPECIAL_DAYS_"+currentSuffix,exerciseStart:"EXERCISE_START_"+currentSuffix,periodMeta:"PERIOD_META_REPORT_"+currentSuffix};
let data=JSON.parse(localStorage.getItem(STORAGE.data))||{};
let closures=JSON.parse(localStorage.getItem(STORAGE.closures))||[];
let reports=JSON.parse(localStorage.getItem(STORAGE.reports))||{};
let annualDate=localStorage.getItem(STORAGE.annualDate)||"";
let annualRate=Number(localStorage.getItem("ANNUAL_RATE_"+currentSuffix))||10;
let specialDays=JSON.parse(localStorage.getItem(STORAGE.specialDays))||{};
let exerciseStart=localStorage.getItem(STORAGE.exerciseStart)||"";
let periodMeta=JSON.parse(localStorage.getItem(STORAGE.periodMeta))||{};
let BASE_HEBDO=Number(localStorage.getItem("BASE_HEBDO_"+currentSuffix))||35;
let AUTO_FERIE=localStorage.getItem("AUTO_FERIE_"+currentSuffix)==="true";
const DAILY_WORK_HOURS=7,ALLOW_RECUP_FREE=true;
const months=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
const monthSelect=document.getElementById("monthSelect");
const yearSelect=document.getElementById("yearSelect");
const periodSelect=document.getElementById("periodSelect");
const calendar=document.getElementById("calendar");
const periodInfo=document.getElementById("periodInfo");
const totaux=document.getElementById("totaux");
const popup=document.getElementById("popup");
const popupDate=document.getElementById("popupDate");
const manualExtra=document.getElementById("manualExtra");
const manualRecup=document.getElementById("manualRecup");
const isAbsent=document.getElementById("isAbsent");
const absentHours=document.getElementById("absentHours");
const popupJSON=document.getElementById("popupJSON");
const jsonTitle=document.getElementById("jsonTitle");
const jsonArea=document.getElementById("jsonArea");
let view=new Date(),viewMonth=view.getMonth(),viewYear=view.getFullYear();
let selectedDate="",currentPeriodIndex=0;

function dateKeyLocal(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
function getBaseStartDate(){return exerciseStart?new Date(exerciseStart):null;}

function initSelectors(){
  monthSelect.innerHTML="";
  months.forEach((m,i)=>{const o=document.createElement("option");o.value=i;o.textContent=m;if(i===viewMonth)o.selected=true;monthSelect.appendChild(o);});
  yearSelect.innerHTML="";
  for(let y=viewYear-2;y<=2050;y++){const o=document.createElement("option");o.value=y;o.textContent=y;if(y===viewYear)o.selected=true;yearSelect.appendChild(o);}
}

function openClosures(){const box=document.getElementById("closuresInputs");box.innerHTML="";for(let i=0;i<13;i++){const inp=document.createElement("input");inp.type="date";inp.value=closures[i]||"";box.appendChild(inp);}document.getElementById("popupClosures").style.display="flex";}
function closeClosures(){document.getElementById("popupClosures").style.display="none";}

/* PATCH 1 ‚Äî forceSunday : T12:00:00 + dateKeyLocal (fix bug timezone UTC) */
function forceSunday(dateStr){
  if(!dateStr)return dateStr;
  const d=new Date(dateStr+'T12:00:00');
  const day=d.getDay();
  if(day!==0)d.setDate(d.getDate()-day);
  return dateKeyLocal(d);
}

/* PATCH 2 ‚Äî forceMonday : avance au lundi suivant, m√™me protection UTC */
function forceMonday(dateStr){
  if(!dateStr)return dateStr;
  const d=new Date(dateStr+'T12:00:00');
  const day=d.getDay();
  if(day!==1){const diff=day===0?1:(8-day);d.setDate(d.getDate()+diff);}
  return dateKeyLocal(d);
}

function saveClosures(){
  let adj=false;
  closures=[...document.querySelectorAll("#closuresInputs input")].map(i=>{const f=forceSunday(i.value);if(i.value&&i.value!==f)adj=true;return f;}).filter(v=>v).sort();
  localStorage.setItem(STORAGE.closures,JSON.stringify(closures));
  if(adj)alert("‚ÑπÔ∏è Toute cl√¥ture doit √™tre un dimanche.\nLes dates saisies ont √©t√© automatiquement ajust√©es.");
  buildPeriods();closeClosures();
}

function buildPeriods(){
  const base=getBaseStartDate();
  if(!base){periodSelect.innerHTML="";if(typeof update==="function")update();return;}
  periodSelect.innerHTML="";
  let start=new Date(base);start.setHours(0,0,0,0);
  const today=new Date();today.setHours(0,0,0,0);
  let found=null;const periods=[];
  closures.forEach((c,i)=>{
    const end=new Date(c);end.setHours(0,0,0,0);
    const opt=document.createElement("option");opt.value=i;
    opt.textContent=`${start.toLocaleDateString()} \u2192 ${end.toLocaleDateString()}`;
    periodSelect.appendChild(opt);
    periods.push({start:new Date(start),end:new Date(end),index:i});
    if(today>=start&&today<=end)found=i;
    start=new Date(end);start.setDate(start.getDate()+1);
  });
  if(closures.length===0){found=0;}
  else if(found===null){if(today<periods[0].start)found=0;else found=closures.length-1;}
  found=Math.max(0,found);
  currentPeriodIndex=found;periodSelect.selectedIndex=found;
  if(typeof update==="function")update();
}

function toggleConfigLock(){const key="CONFIG_LOCK_"+currentSuffix;localStorage.setItem(key,!(localStorage.getItem(key)==="true"));applyConfigLock();}
function applyConfigLock(){const locked=localStorage.getItem("CONFIG_LOCK_"+currentSuffix)==="true";document.querySelectorAll("#exerciseStartInput,#baseHebdoInput,#annualDateInput").forEach(el=>el.disabled=locked);const info=document.getElementById("configLockInfo");if(info)info.textContent=locked?"üîí Configuration verrouill√©e":"üîì Configuration modifiable";}

function getCurrentPeriod(){
  const base=getBaseStartDate();if(!base)return null;
  let start=base;
  for(let i=0;i<=closures.length;i++){const end=i<closures.length?new Date(closures[i]):new Date(2099,11,31);if(i===currentPeriodIndex)return{start,end,index:i};start=new Date(end);start.setDate(start.getDate()+1);}
  return null;
}

function ensureReportsUpTo(index){const sv=currentPeriodIndex;for(let i=0;i<index;i++){currentPeriodIndex=i;calculate();}currentPeriodIndex=sv;}

function generateCalendar(){
  calendar.innerHTML="";
  const firstDay=new Date(viewYear,viewMonth,1).getDay();
  const offset=firstDay===0?6:firstDay-1;
  const days=new Date(viewYear,viewMonth+1,0).getDate();
  for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"));
  const period=getCurrentPeriod();
  let pStart=null,pEnd=null;
  if(period){pStart=new Date(period.start);pEnd=new Date(period.end);pStart.setHours(0,0,0,0);pEnd.setHours(0,0,0,0);}
  for(let d=1;d<=days;d++){
    const key=`${viewYear}-${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const div=document.createElement("div");div.className="day";
    if(period){const dk=new Date(key);if(pStart&&dk>=pStart&&dk<=pEnd)div.classList.add("in-period");}
    const day=data[key]||{extra:0,recup:0,absent:0};
    let html=`<strong>${d}</strong>`;
    if(day.extra)html+=`<small style="color:#000;font-weight:600">+${day.extra}h</small>`;
    if(day.recup)html+=`<small style="color:#ef6c00">-${day.recup}h</small>`;
    if(specialDays[key]==="ferie"){html+=`<small style="color:#0d47a1;font-weight:bold">üéå F√©ri√©</small>`;div.style.background="#e3f2fd";div.style.border="2px dashed #1976d2";}
    else if(day.absent){html+=`<small style="color:#c62828;font-weight:bold">ABS ${day.absent}h</small>`;div.style.background="#ffebee";div.style.border="2px solid #c62828";}
    div.innerHTML=html;
    if(key===dateKeyLocal(new Date()))div.classList.add("today");
    div.onclick=()=>openPopup(key);calendar.appendChild(div);
  }
}

function getLastValidReport(index){for(let i=index-1;i>=0;i--)if(reports[i]!==undefined&&reports[i]!==null)return Number(reports[i])||0;return 0;}

function calculate(){
  const period=getCurrentPeriod();
  if(!period){totaux.innerHTML=`<div style="background:#fff3cd;border:1px solid #ffeeba;padding:12px;border-radius:8px;color:#856404">‚ÑπÔ∏è D√©finissez une date de d√©but d'exercice et des cl√¥tures pour activer les calculs.</div>`;return;}
  if(periodMeta[period.index]?.status==="deleted"){totaux.innerHTML="<i>‚ùå Cette p√©riode est supprim√©e</i>";return;}
  let weeks={},absences={},recups={},totalRecup=0,details=[],h25=0,h50=0;
  ensureReportsUpTo(period.index);
  const reportPrev=getLastValidReport(period.index);
  periodInfo.innerHTML=`<b>P√©riode :</b> ${period.start.toLocaleDateString()} \u2192 ${period.end.getFullYear()===2099?"en cours":period.end.toLocaleDateString()}<br><b>Report pr√©c√©dent :</b> ${reportPrev.toFixed(2)} h`;
  const pStart=new Date(period.start);pStart.setHours(0,0,0,0);
  const pEnd=new Date(period.end);pEnd.setHours(0,0,0,0);
  if(AUTO_FERIE){Object.entries(specialDays).forEach(([date,type])=>{if(type!=="ferie")return;const d=new Date(date);if(d<pStart||d>pEnd)return;const dow=d.getDay();if(dow===0||dow===6)return;if(!data[date]||!data[date].absent){const iso=dow===0?7:dow;const monday=new Date(d);monday.setDate(monday.getDate()-(iso-1));const wk=dateKeyLocal(monday);absences[wk]=(absences[wk]||0)+DAILY_WORK_HOURS;}});}
  Object.entries(data).forEach(([date,v])=>{const[y,m,d]=date.split("-").map(Number);const dd=new Date(y,m-1,d);const dow=dd.getDay();if(dd<pStart||dd>pEnd)return;const iso=dow===0?7:dow;const monday=new Date(dd);monday.setDate(monday.getDate()-(iso-1));if(monday<pStart||monday>pEnd)return;const wk=dateKeyLocal(monday);weeks[wk]=(weeks[wk]||0)+(v.extra||0);if(dow!==0&&dow!==6)absences[wk]=(absences[wk]||0)+(v.absent||0);recups[wk]=(recups[wk]||0)+(v.recup||0);totalRecup+=v.recup||0;});
  Object.entries(weeks).forEach(([week,extra])=>{const absent=absences[week]||0;const base=Math.max(0,BASE_HEBDO-absent);const total=base+extra;let w25=0,w50=0;if(total>BASE_HEBDO)w25=Math.min(total,BASE_HEBDO+8)-BASE_HEBDO;if(total>BASE_HEBDO+8)w50=total-(BASE_HEBDO+8);w25=Math.max(0,w25);w50=Math.max(0,w50);h25+=w25;h50+=w50;const[y,m,d]=week.split("-");details.push(`Semaine du ${new Date(y,m-1,d).toLocaleDateString()} : ${w25.toFixed(2)}h √† 25% / ${w50.toFixed(2)}h √† 50%`);});
  const brut25=h25*1.25,brut50=h50*1.5;
  const brut=brut25+brut50+reportPrev,net=brut-totalRecup;
  reports[period.index]=net;localStorage.setItem(STORAGE.reports,JSON.stringify(reports));
  totaux.innerHTML=`<details class="calc-details"><summary>üìä D√©tails des calculs</summary><div class="breakdown">${details.join("<br>")}<hr>25% : ${h25}h √ó 1,25 = ${brut25.toFixed(2)} h<br>50% : ${h50}h √ó 1,50 = ${brut50.toFixed(2)} h<br>Report pr√©c√©dent : ${reportPrev.toFixed(2)} h</div></details><hr><b>Solde brut :</b> ${brut.toFixed(2)} h<br>R√©cup : ${totalRecup.toFixed(2)} h<br><b>Solde net :</b> ${net.toFixed(2)} h`;
  const rateContainer=document.getElementById("rateContainer");rateContainer.innerHTML="";
  if(shouldShowAnnualClosure()){rateContainer.innerHTML=`<div style="background:#e0f4f7;padding:10px;border-radius:6px;border:1px solid #4FB3C2;margin-top:10px;box-sizing:border-box;width:100%;"><label style="display:block;font-weight:bold;margin-bottom:4px;">Taux horaire (‚Ç¨)</label><input type="number" id="hourlyRateInput" step="0.5" value="${annualRate}" style="width:100%;box-sizing:border-box;margin:0;"></div>`;document.getElementById("hourlyRateInput").oninput=()=>{const v=Number(document.getElementById("hourlyRateInput").value);annualRate=isNaN(v)?10:v;localStorage.setItem("ANNUAL_RATE_"+currentSuffix,annualRate);calculate();};totaux.innerHTML+=`<hr><div style="background:#e0f4f7;padding:15px;border:2px solid #2196a6;border-radius:8px;"><h3 style="margin:0;color:#2196a6;">üéØ Cl√¥ture Annuelle</h3><b>Paiement (${annualRate}‚Ç¨/h) :</b> ${(net*annualRate).toFixed(2)} ‚Ç¨</div>`;}
}

function openNotice(){document.getElementById("popupNotice").style.display="flex";}
function closeNotice(){document.getElementById("popupNotice").style.display="none";}
function openPopup(date){
  selectedDate=date;
  if(specialDays[date]==="ferie"&&!AUTO_FERIE){if(!data[date])data[date]={extra:0,recup:0,absent:0};data[date].absent=DAILY_WORK_HOURS;}
  const d=data[date]||{extra:0,recup:0,absent:0};
  popupDate.textContent=date;manualExtra.value=d.extra;manualRecup.value=d.recup;
  absentHours.value=d.absent||0;isAbsent.checked=(d.absent||0)>0;
  lockBodyScroll();popup.style.display="flex";
}
function closePopup(){document.getElementById("popup").style.display="none";const had=selectedDate;selectedDate="";unlockBodyScroll();if(had&&typeof update==="function")update();}
function save(){
  localStorage.setItem(STORAGE.data,JSON.stringify(data));
  localStorage.setItem("AUTO_SAVE_DATE_"+currentSuffix,new Date().toISOString());
  if(selectedDate){const affectedPeriod=getPeriodIndexForDate(selectedDate);if(affectedPeriod!==null){for(let i=affectedPeriod;i<=closures.length+1;i++)delete reports[i];localStorage.setItem(STORAGE.reports,JSON.stringify(reports));}}
  updateSaveBadges();
}
function getPeriodIndexForDate(dateStr){const base=getBaseStartDate();if(!base)return 0;const d=new Date(dateStr);d.setHours(0,0,0,0);if(!closures.length)return 0;let start=new Date(base);start.setHours(0,0,0,0);for(let i=0;i<closures.length;i++){const end=new Date(closures[i]);end.setHours(0,0,0,0);if(d>=start&&d<=end)return i;start=new Date(end);start.setDate(start.getDate()+1);}return Math.max(0,closures.length-1);}
function isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent);}
function createSnapshot(label){const key="SNAPSHOT_"+Date.now();localStorage.setItem(key,JSON.stringify({label,date:new Date().toISOString(),data,closures,reports,periodMeta,exerciseStart,annualDate,specialDays,BASE_HEBDO,annualRate}));const snaps=Object.keys(localStorage).filter(k=>k.startsWith("SNAPSHOT_")).sort();while(snaps.length>5)localStorage.removeItem(snaps.shift());}
function exportJSON(){createSnapshot("before_export");const blob=new Blob([JSON.stringify({version:1,exercise:currentSuffix,data,closures,reports,periodMeta,exerciseStart,annualDate,specialDays,BASE_HEBDO,annualRate},null,2)],{type:"application/json"});const fn=`heures_sup_${currentSuffix}.json`;if(navigator.canShare&&navigator.canShare({files:[new File([blob],fn)]})){localStorage.setItem("FILE_SAVE_DATE_"+currentSuffix,new Date().toISOString());updateSaveBadges();navigator.share({files:[new File([blob],fn,{type:"application/json"})],title:"Sauvegarde heures suppl√©mentaires"});return;}const url=URL.createObjectURL(blob),a=document.createElement("a");a.href=url;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);localStorage.setItem("FILE_SAVE_DATE_"+currentSuffix,new Date().toISOString());updateSaveBadges();}
function importJSON(){if(isIOS()){jsonTitle.textContent="Collez le texte JSON (Import)";jsonArea.value="";popupJSON.style.display="flex";}else{const inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=e=>{const r=new FileReader();r.onload=()=>loadJSON(r.result);r.readAsText(e.target.files[0]);};inp.click();}}
function updateSaveBadges(){const ae=document.getElementById("autoSaveBadge"),fe=document.getElementById("fileSaveBadge");if(!ae||!fe)return;const a=localStorage.getItem("AUTO_SAVE_DATE_"+currentSuffix);const f=localStorage.getItem("FILE_SAVE_DATE_"+currentSuffix);ae.textContent=a?"üü¢ Dans l'application : "+new Date(a).toLocaleString():"üü¢ Dans l'application : ‚Äî";fe.textContent=f?"üíæ Sauvegarde fichier : "+new Date(f).toLocaleString():"üíæ Sauvegarde fichier : ‚Äî";}
function confirmImportJSON(){loadJSON(jsonArea.value);closeJSONPopup();}
function loadJSON(text){let obj;try{obj=JSON.parse(text);}catch(e){alert("‚ùå JSON invalide");return;}if(obj.version!==1){alert("‚ùå Version de sauvegarde incompatible");return;}if(obj.exercise&&String(obj.exercise)!==String(currentSuffix)){if(!confirm(`‚ö†Ô∏è Ce fichier appartient √† l'exercice ${obj.exercise}.\n\nVoulez-vous basculer automatiquement dessus ?`))return;localStorage.setItem("ACTIVE_YEAR_SUFFIX",obj.exercise);location.reload();return;}if(!obj.data||!obj.closures){alert("‚ùå Sauvegarde invalide ou incompl√®te");return;}if(!confirm("‚ö†Ô∏è Cette action va remplacer les donn√©es de l'exercice en cours.\n\nContinuer ?"))return;createSnapshot("before_import");data=obj.data;closures=obj.closures;reports=obj.reports||{};periodMeta=obj.periodMeta||{};exerciseStart=obj.exerciseStart||"";annualDate=obj.annualDate||"";specialDays=obj.specialDays||{};BASE_HEBDO=Number(obj.BASE_HEBDO)||35;annualRate=Number(obj.annualRate)||10;localStorage.setItem(STORAGE.data,JSON.stringify(data));localStorage.setItem(STORAGE.closures,JSON.stringify(closures));localStorage.setItem(STORAGE.reports,JSON.stringify(reports));localStorage.setItem(STORAGE.periodMeta,JSON.stringify(periodMeta));localStorage.setItem(STORAGE.exerciseStart,exerciseStart);localStorage.setItem(STORAGE.annualDate,annualDate);localStorage.setItem(STORAGE.specialDays,JSON.stringify(specialDays));localStorage.setItem("BASE_HEBDO_"+currentSuffix,BASE_HEBDO);localStorage.setItem("ANNUAL_RATE_"+currentSuffix,annualRate);if(typeof update==="function")update();alert("‚úÖ Import complet r√©ussi");}
function closeJSONPopup(){popupJSON.style.display="none";}
async function importFeries(){const by=Number(currentSuffix),years=[by-1,by,by+1];if(!confirm(`Importer les jours f√©ri√©s officiels pour ${years.join(", ")} ?`))return;try{for(const y of years){const res=await fetch(`https://calendrier.api.gouv.fr/jours-feries/metropole/${y}.json`);const f=await res.json();Object.keys(f).forEach(d=>{if(!specialDays[d])specialDays[d]="ferie";});}localStorage.setItem(STORAGE.specialDays,JSON.stringify(specialDays));localStorage.setItem(STORAGE.data,JSON.stringify(data));if(typeof update==="function")update();alert("‚úÖ Jours f√©ri√©s import√©s (N-1 / N / N+1)");}catch(e){alert("‚ùå Impossible d'importer les jours f√©ri√©s");}}
function update(){
  checkExerciseStartAlert();generateCalendar();calculate();applyConfigLock();updateSaveBadges();
  const aft=document.getElementById("autoFerieToggle");
  if(aft){aft.checked=AUTO_FERIE;aft.onchange=()=>{AUTO_FERIE=aft.checked;localStorage.setItem("AUTO_FERIE_"+currentSuffix,AUTO_FERIE);update();};}
  const banner=document.getElementById("activePeriodBanner"),period=getCurrentPeriod();
  if(banner){if(period&&exerciseStart){const s=period.start.toLocaleDateString(),e=period.end.getFullYear()===2099?"en cours":period.end.toLocaleDateString();banner.innerHTML=`üìò P√©riode ${period.index+1} : ${s} \u2192 ${e}`;}else banner.innerHTML="";}
}
monthSelect.onchange=()=>{viewMonth=+monthSelect.value;if(typeof update==="function")update();};
yearSelect.onchange=()=>{viewYear=+yearSelect.value;if(typeof update==="function")update();};
periodSelect.onchange=()=>{currentPeriodIndex=+periodSelect.value;if(typeof update==="function")update();showToast();};
const annualDateInput=document.getElementById("annualDateInput");
const exerciseStartInput=document.getElementById("exerciseStartInput");
const baseHebdoInput=document.getElementById("baseHebdoInput");
annualDateInput.value=annualDate;
exerciseStartInput.value=exerciseStart;
baseHebdoInput.value=BASE_HEBDO;
annualDateInput.onchange=()=>{annualDate=forceSunday(annualDateInput.value);annualDateInput.value=annualDate;localStorage.setItem(STORAGE.annualDate,annualDate);};
/* PATCH 3 ‚Äî forceMonday sur la date de d√©but d'exercice dans les settings */
exerciseStartInput.onchange=()=>{exerciseStart=forceMonday(exerciseStartInput.value);exerciseStartInput.value=exerciseStart;localStorage.setItem(STORAGE.exerciseStart,exerciseStart);buildPeriods();};
baseHebdoInput.oninput=()=>{BASE_HEBDO=Number(baseHebdoInput.value)||35;localStorage.setItem("BASE_HEBDO_"+currentSuffix,BASE_HEBDO);if(typeof update==="function")update();};

function exportMonthlyFullPDF(){createSnapshot("before_export");const{jsPDF}=window.jspdf;const pdf=new jsPDF();let y=15;pdf.setFontSize(14);pdf.text("Compteur annuel d'heures ‚Äì R√©capitulatif mensuel",10,y);y+=10;pdf.setFontSize(10);pdf.text(`Mois : ${months[viewMonth]} ${viewYear}`,10,y);y+=6;pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`,10,y);y+=6;const period=getCurrentPeriod();if(period){pdf.text("P√©riode comptable : p√©riode active au moment de l'export",10,y);y+=6;}pdf.line(10,y,200,y);y+=8;let wks={},abs={},rec={},t25=0,t50=0,tR=0;Object.entries(data).forEach(([date,v])=>{const d=new Date(date);if(d.getFullYear()!==viewYear||d.getMonth()!==viewMonth)return;const dow=d.getDay(),iso=dow===0?7:dow;const mon=new Date(d);mon.setDate(mon.getDate()-(iso-1));const wk=dateKeyLocal(mon);wks[wk]=(wks[wk]||0)+(v.extra||0);rec[wk]=(rec[wk]||0)+(v.recup||0);if(dow!==0&&dow!==6)abs[wk]=(abs[wk]||0)+(v.absent||0);});Object.keys(wks).sort().forEach(w=>{const base=Math.max(0,BASE_HEBDO-(abs[w]||0)-(rec[w]||0)),total=base+wks[w];let h25=0,h50=0;if(total>BASE_HEBDO)h25=Math.min(total,BASE_HEBDO+8)-BASE_HEBDO;if(total>BASE_HEBDO+8)h50=total-(BASE_HEBDO+8);t25+=Math.max(0,h25);t50+=Math.max(0,h50);tR+=rec[w]||0;pdf.text(`Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h 25% / ${h50.toFixed(2)}h 50%`,10,y);y+=6;if(y>270){pdf.addPage();y=15;}});y+=6;pdf.line(10,y,200,y);y+=8;pdf.text(`Total 25 % : ${t25.toFixed(2)} h`,10,y);y+=6;pdf.text(`Total 50 % : ${t50.toFixed(2)} h`,10,y);y+=6;pdf.text(`R√©cup√©rations : ${tR.toFixed(2)} h`,10,y);y+=10;pdf.setFontSize(8);pdf.text("Document informatif ‚Äì ne constitue pas un bulletin de paie.",10,y);pdf.save(`mensuel_${months[viewMonth]}_${viewYear}.pdf`);}
function exportAnnualPDF(){createSnapshot("before_export");const{jsPDF}=window.jspdf;const pdf=new jsPDF();let y=15,annualNet=0;const addH=(t)=>{pdf.setFontSize(14);pdf.text(t,10,y);y+=8;pdf.setFontSize(10);pdf.text(`Exercice : ${currentSuffix}`,10,y);y+=8;pdf.line(10,y,200,y);y+=6;};addH("Compteur annuel d'heures ‚Äì Bilan annuel");closures.forEach((_,idx)=>{if(periodMeta[idx]?.status==="deleted")return;let start=getBaseStartDate(),period=null;for(let i=0;i<=closures.length;i++){const end=i<closures.length?new Date(closures[i]):new Date(2099,11,31);if(i===idx){period={start,end};break;}start=new Date(end);start.setDate(start.getDate()+1);}if(!period)return;if(y>230){pdf.addPage();y=15;addH("Suite ‚Äì Bilan annuel");}pdf.setFontSize(12);pdf.text(`P√©riode ${idx+1} : ${period.start.toLocaleDateString()} ‚Üí ${period.end.getFullYear()===2099?"en cours":period.end.toLocaleDateString()}`,10,y);y+=6;pdf.setFontSize(9);pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`,10,y);y+=5;let wks={},abs={},rec={},p25=0,p50=0,pR=0;Object.entries(data).forEach(([date,v])=>{const d=new Date(date);if(d<period.start||d>period.end)return;const dow=d.getDay(),iso=dow===0?7:dow;const mon=new Date(d);mon.setDate(mon.getDate()-(iso-1));const wk=dateKeyLocal(mon);wks[wk]=(wks[wk]||0)+(v.extra||0);rec[wk]=(rec[wk]||0)+(v.recup||0);if(dow!==0&&dow!==6)abs[wk]=(abs[wk]||0)+(v.absent||0);});Object.keys(wks).sort().forEach(w=>{const base=Math.max(0,BASE_HEBDO-(abs[w]||0)-(rec[w]||0)),total=base+wks[w];let h25=0,h50=0;if(total>BASE_HEBDO)h25=Math.min(total,BASE_HEBDO+8)-BASE_HEBDO;if(total>BASE_HEBDO+8)h50=total-(BASE_HEBDO+8);p25+=Math.max(0,h25);p50+=Math.max(0,h50);pR+=rec[w]||0;pdf.text(`‚Ä¢ Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h 25% / ${h50.toFixed(2)}h 50%`,12,y);y+=4;if(y>270){pdf.addPage();y=15;}});const net=p25*1.25+p50*1.5+getLastValidReport(idx)-pR;annualNet+=net;y+=4;pdf.text(`Total 25 % : ${p25.toFixed(2)} h`,12,y);y+=4;pdf.text(`Total 50 % : ${p50.toFixed(2)} h`,12,y);y+=4;pdf.text(`R√©cup√©rations : ${pR.toFixed(2)} h`,12,y);y+=4;pdf.text(`Solde net de p√©riode : ${net.toFixed(2)} h`,12,y);y+=6;pdf.line(10,y,200,y);y+=6;});if(y>240){pdf.addPage();y=15;}pdf.setFontSize(14);pdf.text("Synth√®se annuelle",10,y);y+=10;pdf.setFontSize(12);pdf.text(`Solde annuel net cumul√© : ${annualNet.toFixed(2)} h`,10,y);y+=14;pdf.setFontSize(10);pdf.text("Validation / Signature :",10,y);y+=10;pdf.rect(10,y,90,20);y+=30;pdf.setFontSize(8);pdf.text("Bilan annuel g√©n√©r√© automatiquement.\nDocument indicatif ‚Äì ne constitue pas un bulletin de paie.",10,y);pdf.save(`annuel_${currentSuffix}.pdf`);}
function exportPeriodPDF(){createSnapshot("before_export");const{jsPDF}=window.jspdf;const pdf=new jsPDF();const period=getCurrentPeriod();if(!period){alert("‚ùå Aucune p√©riode active");return;}let y=15;pdf.setFontSize(14);pdf.text("Compteur annuel d'heures ‚Äì R√©capitulatif de p√©riode",10,y);y+=10;pdf.setFontSize(10);pdf.text(`P√©riode : ${period.start.toLocaleDateString()} ‚Üí ${period.end.getFullYear()===2099?"en cours":period.end.toLocaleDateString()}`,10,y);y+=6;pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`,10,y);y+=14;pdf.line(10,y,200,y);y+=6;let wks={},abs={},rec={},t25=0,t50=0,tR=0;Object.entries(data).forEach(([date,v])=>{const d=new Date(date);if(d<period.start||d>period.end)return;const dow=d.getDay(),iso=dow===0?7:dow;const mon=new Date(d);mon.setDate(mon.getDate()-(iso-1));const wk=dateKeyLocal(mon);wks[wk]=(wks[wk]||0)+(v.extra||0);rec[wk]=(rec[wk]||0)+(v.recup||0);if(dow!==0&&dow!==6)abs[wk]=(abs[wk]||0)+(v.absent||0);});Object.keys(wks).sort().forEach(w=>{const base=Math.max(0,BASE_HEBDO-(abs[w]||0)-(rec[w]||0)),total=base+wks[w];let h25=0,h50=0;if(total>BASE_HEBDO)h25=Math.min(total,BASE_HEBDO+8)-BASE_HEBDO;if(total>BASE_HEBDO+8)h50=total-(BASE_HEBDO+8);t25+=Math.max(0,h25);t50+=Math.max(0,h50);tR+=rec[w]||0;pdf.text(`Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h √† 25% / ${h50.toFixed(2)}h √† 50%`,10,y);y+=6;if(y>270){pdf.addPage();y=15;}});const rp=getLastValidReport(period.index),net=t25*1.25+t50*1.5+rp-tR;y+=6;pdf.line(10,y,200,y);y+=8;pdf.text(`Total 25 % : ${t25.toFixed(2)} h`,10,y);y+=6;pdf.text(`Total 50 % : ${t50.toFixed(2)} h`,10,y);y+=6;pdf.text(`R√©cup√©rations : ${tR.toFixed(2)} h`,10,y);y+=6;pdf.text(`Report pr√©c√©dent : ${rp.toFixed(2)} h`,10,y);y+=6;pdf.setFontSize(12);pdf.text(`Solde net de p√©riode : ${net.toFixed(2)} h`,10,y);y+=12;pdf.setFontSize(10);pdf.text("Validation / Signature :",10,y);y+=10;pdf.rect(10,y,90,20);y+=30;pdf.setFontSize(8);pdf.text("Document g√©n√©r√© automatiquement √† titre informatif.\nNe constitue pas un bulletin de paie.",10,y);pdf.save(`periode_${period.start.toISOString().slice(0,10)}_${currentSuffix}.pdf`);}

function shouldShowAnnualClosure(){if(!annualDate)return false;const ad=new Date(annualDate);return ad.getFullYear()===viewYear&&ad.getMonth()===viewMonth;}
function showToast(){const t=document.getElementById("toast");if(!t)return;t.style.opacity="1";setTimeout(()=>{t.style.opacity="0";},3000);}
const crashState=localStorage.getItem("APP_CRASH_STATE");
if(crashState)console.warn("‚ö†Ô∏è Dernier crash d√©tect√©:",crashState);
let _scrollY=0;
function lockBodyScroll(){_scrollY=window.scrollY;document.body.style.overflow="hidden";document.body.style.position="fixed";document.body.style.top="-"+_scrollY+"px";document.body.style.width="100%";}
function unlockBodyScroll(){document.body.style.overflow="";document.body.style.position="";document.body.style.top="";document.body.style.width="";window.scrollTo(0,_scrollY);}
document.addEventListener("DOMContentLoaded",()=>{protectFunctions();initSelectors();applyConfigLock();buildPeriods();autoSwitchPeriodAtMidnight();if(!exerciseStart)setTimeout(openWizardModal,300);});
function openLegalPopup(){document.getElementById("popupLegal").style.display="flex";}
function closeLegalPopup(){document.getElementById("popupLegal").style.display="none";}
function protectFunctions(){
  if(!update.__safe){update=safe(update,"update");update.__safe=true;}
  if(!calculate.__safe){calculate=safe(calculate,"calculate");calculate.__safe=true;}
  if(!generateCalendar.__safe){generateCalendar=safe(generateCalendar,"calendar");generateCalendar.__safe=true;}
  if(!buildPeriods.__safe){buildPeriods=safe(buildPeriods,"periods");buildPeriods.__safe=true;}
  if(!exportJSON.__safe){exportJSON=safe(exportJSON,"exportJSON");exportJSON.__safe=true;}
  if(!loadJSON.__safe){loadJSON=safe(loadJSON,"importJSON");loadJSON.__safe=true;}
  if(!exportMonthlyFullPDF.__safe){exportMonthlyFullPDF=safe(exportMonthlyFullPDF,"pdf_month");exportMonthlyFullPDF.__safe=true;}
  if(!exportAnnualPDF.__safe){exportAnnualPDF=safe(exportAnnualPDF,"pdf_annual");exportAnnualPDF.__safe=true;}
  if(!exportPeriodPDF.__safe){exportPeriodPDF=safe(exportPeriodPDF,"pdf_period");exportPeriodPDF.__safe=true;}
}
</script>
<div id="toast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:10px 16px;border-radius:20px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .4s;z-index:9999;">&#x1F55B; Nouvelle p√©riode activ√©e automatiquement</div>
<div class="popup" id="popupClosures">
  <div class="popup-content">
    <h3>&#128197; Cl√¥tures comptables</h3>
    <div id="closuresInputs"></div>
    <button onclick="saveClosures()">Enregistrer</button>
    <button onclick="closeClosures()">Fermer</button>
  </div>
</div>
<div style="text-align:center;font-size:12px;color:#666;margin-top:30px;">
  <a href="#" onclick="event.preventDefault();openLegalPopup();">&#x2139;&#65039; Informations l√©gales &amp; calcul</a>
  <a href="#" onclick="event.preventDefault();openNotice();">&#x1F4D8; Notice utilisateur</a>
  <button type="button" onclick="protectedCrash()" style="margin-left:10px;background:none;border:none;padding:0;color:#777;font-size:12px;cursor:pointer;user-select:none;">&copy; C.Anthony</button>
</div>
<p style="max-width:900px;margin:20px auto;font-size:12px;color:#555;background:#fffde7;border:1px solid #ffe082;padding:12px;border-radius:8px;text-align:center;">
  &#9888;&#65039; <b>Sauvegarde des donn√©es</b><br><br>
  Les donn√©es saisies dans cette application sont enregistr√©es <b>localement sur cet appareil</b>.<br><br>
  <b>Il est fortement recommand√© d'effectuer des exports r√©guliers</b> (mensuels ou apr√®s chaque cl√¥ture).
</p>
<div class="popup" id="popupLegal">
  <div class="popup-content" style="max-width:700px;max-height:80vh;overflow:auto;">
    <h3>‚ÑπÔ∏è Informations l√©gales &amp; r√®gles de calcul</h3>
    <div style="font-size:12px;color:#9aa0a6;line-height:1.5"><b>‚ö†Ô∏è Responsabilit√© et limites</b><br><br>Les donn√©es saisies dans ce simulateur sont renseign√©es <b>sous la seule responsabilit√© de l'utilisateur</b>.<br><br>Les r√©sultats affich√©s sont fournis √† titre indicatif et peuvent ne pas refl√©ter exactement la r√©alit√© du terrain, notamment en raison d'erreurs de saisie, de param√®tres incomplets, de diff√©rences li√©es √† la convention collective, aux accords d'entreprise, aux pratiques internes, d'√©volutions du droit applicable, ou de <b>dysfonctionnements techniques, bugs ou limites du simulateur</b>.<br><br><b>Seuls les documents √©tablis par l'employeur et le droit applicable font foi.</b></div>
    <p>Cet outil a pour finalit√© d'aider au suivi, √† l'estimation et √† la compr√©hension du temps de travail, des heures suppl√©mentaires, des r√©cup√©rations et des soldes horaires, √† partir des donn√©es saisies par l'utilisateur.</p>
    <hr><h4>‚öôÔ∏è Fonctionnement g√©n√©ral</h4>
    <p>Cet outil fonctionne comme un <b>compteur annuel du temps de travail</b>.<br><br>Les <b>absences</b> r√©duisent le volume d'heures attendues dans la semaine. Elles diminuent donc la base sur laquelle les heures suppl√©mentaires sont calcul√©es et r√©duisent le <b>solde brut</b>.<br><br>Les <b>r√©cup√©rations</b> repr√©sentent des heures d√©j√† comptabilis√©es dans le solde et prises ult√©rieurement en repos. Elles ne r√©duisent pas la base de calcul des heures suppl√©mentaires : elles sont uniquement soustraites du solde brut pour obtenir le <b>solde net</b>.</p>
    <hr><h4>‚öñÔ∏è Cadre juridique de r√©f√©rence</h4>
    <p>Les r√®gles de calcul appliqu√©es reposent sur les principes g√©n√©raux du Code du travail et de la convention collective nationale du commerce de gros (IDCC 573), dans leur version en vigueur au moment de l'utilisation.</p>
    <p>Ces r√®gles sont susceptibles d'√©voluer et peuvent √™tre am√©nag√©es par des accords d'entreprise, des usages internes ou des dispositions contractuelles sp√©cifiques.</p>
    <hr><h4>üéå Jours f√©ri√©s</h4>
    <p>Un jour f√©ri√© ch√¥m√© et pay√© ne constitue pas du temps de travail effectif. Il entra√Æne une r√©duction du temps de travail attendu (par d√©faut 7 heures pour une journ√©e compl√®te), sans modifier le seuil l√©gal de d√©clenchement des heures suppl√©mentaires.</p>
    <p>Les heures suppl√©mentaires sont d√©clench√©es uniquement √† partir de la <b>36·µâ heure r√©ellement travaill√©e</b> dans la semaine, y compris lorsqu'un ou plusieurs jours f√©ri√©s sont pr√©sents.</p>
    <hr><h4>‚ùå Absences</h4>
    <p>Les absences correspondent √† des p√©riodes non travaill√©es imputables au salari√©. Elles sont prises en compte uniquement sur les jours ouvr√©s et <b>r√©duisent le volume d'heures travaillables</b> servant de base au calcul hebdomadaire.<br><br>Cons√©quence : les absences diminuent le solde brut de la p√©riode.</p>
    <hr><h4>üîÅ R√©cup√©rations</h4>
    <p>Les r√©cup√©rations correspondent √† des heures pr√©c√©demment travaill√©es et ult√©rieurement non travaill√©es.<br><br>Elles <b>ne r√©duisent pas la base hebdomadaire</b> de calcul des heures suppl√©mentaires. Elles sont uniquement soustraites du solde brut pour obtenir le <b>solde net</b>.<br><br>Exemple : 2h suppl√©mentaires effectu√©es + 1h r√©cup√©r√©e ‚Üí solde brut = 2h (major√©es), solde net = solde brut ‚àí 1h r√©cup.</p>
    <hr><h4>‚ûï Heures suppl√©mentaires</h4>
    <p>Le seuil de d√©clenchement correspond √† l'√©quivalent de 35 heures hebdomadaires, ajust√© selon les absences uniquement.</p>
    <ul><li>Heures de la 36·µâ √† la 43·µâ heure : majoration de 25 %</li><li>Heures au-del√† de la 43·µâ heure : majoration de 50 %</li></ul>
    <hr><h4>üìö Sources officielles</h4>
    <ul><li><a href="https://www.legifrance.gouv.fr/codes/id/LEGITEXT000006072050/" target="_blank" rel="noopener">Code du travail ‚Äì L√©gifrance</a></li><li><a href="https://www.legifrance.gouv.fr/conv_coll/id/KALICONT000005635624" target="_blank" rel="noopener">Convention collective nationale du commerce de gros (IDCC 573)</a></li></ul>
    <p style="font-size:11px;color:#aaa;">Cet outil ne constitue pas un conseil juridique et ne se substitue pas √† l'analyse d'un professionnel comp√©tent.</p>
    <button onclick="closeLegalPopup()">Fermer</button>
  </div>
</div>
<div class="popup" id="popupYears">
  <div class="popup-content">
    <h3>&#128193; Exercices existants</h3>
    <div id="yearsList"></div>
    <hr>
    <label>Cr√©er / ouvrir un nouvel exercice</label>
    <input type="number" id="newYearInput" placeholder="Ex : 2039">
    <button onclick="confirmSwitchYear()">Ouvrir</button>
    <button onclick="closeYearsPopup()">Fermer</button>
  </div>
</div>
<!-- WIZARD -->
<div class="popup" id="wizardModal">
  <div class="popup-content" style="max-width:540px;">
    <div class="sheet-handle"></div>
    <div class="wiz-progress"><div class="wiz-progress-bar" id="wizProgressBar" style="width:20%"></div></div>
    <span class="wiz-step-label" id="wizStepLabel">√âtape 1 / 5</span>
    <div class="wiz-step wiz-active" id="wizStep1">
      <div class="wiz-question">üìÖ Quelle est la date de d√©but de ton exercice ?</div>
      <p class="wiz-hint">Ce doit √™tre un <b>lundi</b>. La date sera automatiquement avanc√©e au lundi suivant si n√©cessaire.</p>
      <input type="date" id="wizStartDate">
      <div class="wiz-nav"><button class="kitsune-btn" onclick="wizGoTo(2)">Suivant ‚Üí</button></div>
    </div>
    <div class="wiz-step" id="wizStep2">
      <div class="wiz-question">üìÜ Comment veux-tu d√©finir tes cl√¥tures mensuelles ?</div>
      <div class="wiz-choice-row">
        <div class="wiz-choice-btn" id="wizChoiceAuto" onclick="wizSelectClosureMode('auto')">ü§ñ Automatique<br><small style="font-weight:400;color:#999;">Dernier dimanche de chaque mois</small></div>
        <div class="wiz-choice-btn" id="wizChoiceManual" onclick="wizSelectClosureMode('manual')">‚úèÔ∏è Manuel<br><small style="font-weight:400;color:#999;">Je saisis les 12 dates moi-m√™me</small></div>
      </div>
      <div id="wizManualDates" style="display:none;"><div class="wiz-closures-grid" id="wizClosuresGrid"></div></div>
      <div id="wizAutoInfo" style="display:none;font-size:13px;color:#2196a6;background:#e0f4f7;border-radius:8px;padding:10px;margin-bottom:10px;">‚úÖ Les 12 derniers dimanches de chaque mois seront g√©n√©r√©s automatiquement.</div>
      <div class="wiz-nav">
        <button onclick="wizGoTo(1)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizGoTo(3)">Suivant ‚Üí</button>
      </div>
    </div>
    <div class="wiz-step" id="wizStep3">
      <div class="wiz-question">üèÅ Date de cl√¥ture annuelle finale ?</div>
      <p class="wiz-hint">Cette date marque la fin de l'exercice. Elle sera automatiquement ramen√©e au dimanche le plus proche.</p>
      <input type="date" id="wizAnnualDate">
      <p id="wizAnnualDateInfo" style="font-size:12px;color:#888;margin-top:4px;"></p>
      <div class="wiz-nav">
        <button onclick="wizGoTo(2)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizGoTo(4)">Suivant ‚Üí</button>
      </div>
    </div>
    <div class="wiz-step" id="wizStep4">
      <div class="wiz-question">üá´üá∑ Configurer pour la France ?</div>
      <p class="wiz-hint">Ces options sont recommand√©es pour les contrats relevant du droit fran√ßais.</p>
      <label class="wiz-check-row"><input type="checkbox" id="wizImportFeries" checked><span>üéå Importer les jours f√©ri√©s officiels (API Gouvernement)</span></label>
      <label class="wiz-check-row"><input type="checkbox" id="wizAutoFerie" checked><span>‚öôÔ∏è Mode f√©ri√© automatique : appliquer ‚àí7h les jours f√©ri√©s en semaine</span></label>
      <div class="wiz-nav">
        <button onclick="wizGoTo(3)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizGoTo(5)">Suivant ‚Üí</button>
      </div>
    </div>
    <div class="wiz-step" id="wizStep5">
      <div class="wiz-question">üí∂ Quel est ton taux horaire brut (‚Ç¨) ?</div>
      <p class="wiz-hint">Utilis√© pour estimer le montant des heures suppl√©mentaires lors de la cl√¥ture annuelle.</p>
      <input type="number" id="wizHourlyRate" step="0.5" min="0" value="10" placeholder="Ex : 12.50">
      <div class="wiz-summary" id="wizSummary" style="display:none;margin-top:16px;"><b>R√©capitulatif</b><br><span id="wizSummaryContent"></span></div>
      <div class="wiz-nav">
        <button onclick="wizGoTo(4)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizShowSummary()" id="wizSummaryBtn">Voir le r√©capitulatif ‚Üí</button>
        <button class="kitsune-btn" onclick="finishWiz()" id="wizFinishBtn" style="display:none;">‚úÖ Terminer &amp; Lancer</button>
      </div>
    </div>
  </div>
</div>
<script>
function openSettingsModal(){document.getElementById("exerciseStartInput").value=exerciseStart||"";document.getElementById("annualDateInput").value=annualDate||"";document.getElementById("baseHebdoInput").value=BASE_HEBDO;const aft=document.getElementById("autoFerieToggle");if(aft)aft.checked=AUTO_FERIE;document.getElementById("settingsModal").style.display="flex";lockBodyScroll();}
function closeSettingsModal(){document.getElementById("settingsModal").style.display="none";unlockBodyScroll();if(typeof update==="function")update();}
document.getElementById("settingsModal").addEventListener("click",function(e){if(e.target===this)closeSettingsModal();});
document.getElementById("wizardModal").addEventListener("click",function(e){if(e.target===this)closeWizardModal();});
let wizClosureMode=null,wizCurrentStep=1;
const WIZ_TOTAL=5;
function wizGoTo(step){
  if(step>wizCurrentStep&&!wizValidate(wizCurrentStep))return;
  if(step===5){document.getElementById("wizSummary").style.display="none";document.getElementById("wizSummaryBtn").style.display="inline-block";document.getElementById("wizFinishBtn").style.display="none";}
  document.querySelectorAll(".wiz-step").forEach(s=>s.classList.remove("wiz-active"));
  document.getElementById("wizStep"+step).classList.add("wiz-active");
  document.getElementById("wizProgressBar").style.width=Math.round((step/WIZ_TOTAL)*100)+"%";
  document.getElementById("wizStepLabel").textContent="√âtape "+step+" / "+WIZ_TOTAL;
  wizCurrentStep=step;
  /* PATCH 5 ‚Äî forceMonday sur l'input de date du wizard step 1 */
  if(step===1){const inpS=document.getElementById("wizStartDate");if(inpS&&!inpS._mondayBound){inpS._mondayBound=true;inpS.onchange=()=>{inpS.value=forceMonday(inpS.value);};}}
  if(step===2)wizBuildManualGrid();
  if(step===3){const inp=document.getElementById("wizAnnualDate");inp.onchange=()=>{const f=forceSunday(inp.value);document.getElementById("wizAnnualDateInfo").textContent=f&&f!==inp.value?"üìÖ Date ajust√©e au dimanche : "+new Date(f).toLocaleDateString():"";inp.value=f;};}
}
function wizValidate(step){if(step===1&&!document.getElementById("wizStartDate").value){alert("‚ö†Ô∏è Merci de saisir la date de d√©but d'exercice.");return false;}if(step===2&&!wizClosureMode){alert("‚ö†Ô∏è Choisis un mode de cl√¥ture.");return false;}return true;}
function wizSelectClosureMode(mode){wizClosureMode=mode;document.getElementById("wizChoiceAuto").classList.toggle("wiz-selected",mode==="auto");document.getElementById("wizChoiceManual").classList.toggle("wiz-selected",mode==="manual");document.getElementById("wizManualDates").style.display=mode==="manual"?"block":"none";document.getElementById("wizAutoInfo").style.display=mode==="auto"?"block":"none";}
function wizBuildManualGrid(){const grid=document.getElementById("wizClosuresGrid");if(grid.children.length>0)return;const sv=document.getElementById("wizStartDate").value;const startD=sv?new Date(sv):new Date();const startMonth=startD.getMonth(),startYear=startD.getFullYear();const moisNoms=["Janv.","F√©vr.","Mars","Avr.","Mai","Juin","Juil.","Ao√ªt","Sept.","Oct.","Nov.","D√©c."];for(let i=0;i<13;i++){const month=(startMonth+i)%12;const year=startYear+Math.floor((startMonth+i)/12);const wrap=document.createElement("div");const lbl=document.createElement("label");lbl.textContent=moisNoms[month]+" "+year;const inp=document.createElement("input");inp.type="date";inp.id="wizManDate_"+i;const pre=wizLastSunday(year,month);if(pre)inp.value=pre;inp.onchange=()=>{const f=forceSunday(inp.value);if(f!==inp.value)inp.value=f;};wrap.appendChild(lbl);wrap.appendChild(inp);grid.appendChild(wrap);}}
/* PATCH 6 ‚Äî wizLastSunday : T12:00:00 + dateKeyLocal (fix bug UTC) */
function wizLastSunday(year,month){const last=new Date(year,month+1,0,12,0,0);const dow=last.getDay();if(dow!==0)last.setDate(last.getDate()-dow);return dateKeyLocal(last);}
function wizShowSummary(){const sd=document.getElementById("wizStartDate").value;const ad=document.getElementById("wizAnnualDate").value;const rate=document.getElementById("wizHourlyRate").value||"‚Äî";const feries=document.getElementById("wizImportFeries").checked?"Oui":"Non";const autoF=document.getElementById("wizAutoFerie").checked?"Oui":"Non";const cm=wizClosureMode==="auto"?"Automatique (derniers dimanches)":"Manuel (12 dates saisies)";document.getElementById("wizSummaryContent").innerHTML=`üìÖ D√©but d'exercice : <b>${sd?new Date(sd).toLocaleDateString():"Non d√©finie"}</b><br>üèÅ Cl√¥ture annuelle : <b>${ad?new Date(ad).toLocaleDateString():"Non d√©finie"}</b><br>üìÜ Cl√¥tures : <b>${cm}</b><br>‚è±Ô∏è Base hebdomadaire : <b>35 h</b><br>üéå Jours f√©ri√©s import√©s : <b>${feries}</b><br>‚öôÔ∏è Mode auto-f√©ri√© : <b>${autoF}</b><br>üí∂ Taux horaire : <b>${rate} ‚Ç¨/h</b>`;document.getElementById("wizSummary").style.display="block";document.getElementById("wizSummaryBtn").style.display="none";document.getElementById("wizFinishBtn").style.display="inline-block";}
/* PATCH 7 ‚Äî finishWiz : forceMonday sur la date de d√©but avant sauvegarde */
async function finishWiz(){
  let sd=document.getElementById("wizStartDate").value;if(!sd){alert("‚ùå Date de d√©but manquante.");return;}
  sd=forceMonday(sd);
  exerciseStart=sd;localStorage.setItem(STORAGE.exerciseStart,sd);
  BASE_HEBDO=35;localStorage.setItem("BASE_HEBDO_"+currentSuffix,35);
  const by=new Date(sd).getFullYear();
  if(wizClosureMode==="auto"){closures=[];const startMonth2=new Date(sd).getMonth(),startYear2=new Date(sd).getFullYear();for(let i=0;i<13;i++){const month=(startMonth2+i)%12;const year=startYear2+Math.floor((startMonth2+i)/12);closures.push(wizLastSunday(year,month));}}
  else{closures=[];for(let m=0;m<13;m++){const v=document.getElementById("wizManDate_"+m)?.value;if(v)closures.push(forceSunday(v));}closures=closures.filter(Boolean).sort();}
  localStorage.setItem(STORAGE.closures,JSON.stringify(closures));
  const ra=document.getElementById("wizAnnualDate").value;if(ra){annualDate=forceSunday(ra);localStorage.setItem(STORAGE.annualDate,annualDate);}
  annualRate=Number(document.getElementById("wizHourlyRate").value)||10;localStorage.setItem("ANNUAL_RATE_"+currentSuffix,annualRate);
  AUTO_FERIE=document.getElementById("wizAutoFerie").checked;localStorage.setItem("AUTO_FERIE_"+currentSuffix,AUTO_FERIE);
  if(document.getElementById("wizImportFeries").checked){try{const years=[by-1,by,by+1];for(const y of years){const res=await fetch(`https://calendrier.api.gouv.fr/jours-feries/metropole/${y}.json`);const f=await res.json();Object.keys(f).forEach(d=>{if(!specialDays[d])specialDays[d]="ferie";});}localStorage.setItem(STORAGE.specialDays,JSON.stringify(specialDays));}catch(e){console.warn("Import jours f√©ri√©s √©chou√©:",e);}}
  closeWizardModal();if(typeof buildPeriods==="function")buildPeriods();if(typeof update==="function")update();showToast();
}
function openWizardModal(){wizReset();document.getElementById("wizardModal").style.display="flex";lockBodyScroll();}
function closeWizardModal(){document.getElementById("wizardModal").style.display="none";unlockBodyScroll();}
function restartWizard(){closeSettingsModal();openWizardModal();}
function wizReset(){wizClosureMode=null;wizCurrentStep=1;document.querySelectorAll(".wiz-step").forEach(s=>s.classList.remove("wiz-active"));document.getElementById("wizStep1").classList.add("wiz-active");document.getElementById("wizProgressBar").style.width="20%";document.getElementById("wizStepLabel").textContent="√âtape 1 / 5";document.getElementById("wizStartDate").value=exerciseStart||"";document.getElementById("wizAnnualDate").value=annualDate||"";document.getElementById("wizAnnualDateInfo").textContent="";document.getElementById("wizHourlyRate").value=annualRate||10;document.getElementById("wizImportFeries").checked=true;document.getElementById("wizAutoFerie").checked=AUTO_FERIE;document.getElementById("wizSummary").style.display="none";document.getElementById("wizSummaryBtn").style.display="inline-block";document.getElementById("wizFinishBtn").style.display="none";document.getElementById("wizChoiceAuto").classList.remove("wiz-selected");document.getElementById("wizChoiceManual").classList.remove("wiz-selected");document.getElementById("wizManualDates").style.display="none";document.getElementById("wizAutoInfo").style.display="none";document.getElementById("wizClosuresGrid").innerHTML="";}
</script>
<script>sessionStorage.setItem("appAlive","true");</script>
</body>
</html>