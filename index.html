<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/hs/apple-touch-icon.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Compteur Heures & Paie">
<meta name="theme-color" content="#4FB3C2">
<meta charset="UTF-8">
<title>Simulateur de compteur annuel</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* Bouton Kitsune ‚Üí M3 */
.kitsune-btn {
  flex: 1;
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, #FF8C42, #e06a1a);
  color: #fff;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(255,140,66,0.35);
  transition: transform 0.15s, box-shadow 0.15s;
}
.kitsune-btn:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 16px rgba(255,140,66,0.55);
}
.kitsune-btn:active { transform: scale(0.97); }

/* Wrapper des deux boutons */
.top-nav-bar {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  margin-bottom: 20px;
}
.top-nav-bar .menu-btn {
  flex: 1;
  margin: 0;
}
.menu-btn {
  margin-top: 8px;
  margin-bottom: 20px;
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  background: rgba(255,255,255,0.85);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
}
/* üõ†Ô∏è FIX SAFARI iOS ‚Äî Emp√™cher le r√©tr√©cissement des select */
.month-nav {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  width: 100%;
}

.month-nav select {
  flex: 1;
  min-height: 40px;
  display: block;
  width: 100%;
  box-sizing: border-box;
  background-color: #fff;
  -webkit-appearance: menulist;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* PARTIE 3 ‚Äî d√©tails repliables */
.calc-details summary{
  cursor:pointer;
  font-weight:bold;
  background:#e3f2fd;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
}

.calc-details[open] summary{
  background:#bbdefb;
}
body{font-family:Arial,sans-serif;background:#f2f2f2;padding:15px}
h1,h2{text-align:center}
.config,.totaux{background:#fff;padding:15px;border-radius:8px;max-width:900px;margin:15px auto}
.calendar-wrapper{max-width:900px;margin:20px auto}
.weekdays,.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.weekday{text-align:center;font-weight:bold;background:#ddd;padding:8px 0;border-radius:6px}
.day{
  background:#fff;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
  text-align:center;
  height:80px;
  box-sizing:border-box;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
  .day small{
  font-size:11px;
  line-height:1.1;
  white-space:nowrap;
}
.day.in-period{border:2px solid #2e7d32;background:#e8f5e9}
button,
input,
textarea{
  width:100%;
  padding:8px;
  margin:5px 0;
}
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:1000;
  pointer-events:auto;
  will-change: transform;
  transform: translateZ(0);
  backface-visibility: hidden;
}
.popup-content{
  background:#fff;
  width:100%;
  max-width:500px;
  max-height:calc(100vh - 60px);
  overflow-y:auto;
  border-radius:16px 16px 0 0;
  padding:16px;
  padding-bottom:calc(16px + env(safe-area-inset-bottom));
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.breakdown{background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;font-size:14px}
.day.today{outline:3px solid #ff9800;box-shadow:0 0 6px rgba(255,152,0,.8)}
.sheet-handle{
  width:40px;
  height:4px;
  background:#ccc;
  border-radius:2px;
  margin:6px auto 10px;
}
.block{border:none;margin-bottom:16px}
.block.plus legend{color:#1976d2}
.block.minus legend{color:#ef6c00}
.block.absence legend{color:#c62828}
.popup-actions{
  position:sticky;
  bottom:env(safe-area-inset-bottom);
  background:#fff;
  padding-top:10px;
}

/* ===== SETTINGS BUTTON ===== */
#openSettingsBtn {
  display: block;
  width: calc(100% - 30px);
  max-width: 900px;
  margin: 0 auto 20px;
  padding: 13px 20px;
  background: linear-gradient(135deg, #37474f, #546e7a);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(55,71,79,.3);
  transition: transform .15s, box-shadow .15s;
  text-align: left;
}
#openSettingsBtn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(55,71,79,.45); }
#openSettingsBtn:active { transform: scale(.98); }

/* ===== SETTINGS MODAL LAYOUT ===== */
.settings-group {
  margin-bottom: 18px;
}
.settings-group-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .8px;
  color: #888;
  margin-bottom: 8px;
  display: block;
}
.settings-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 6px;
}
.settings-row button,
.settings-row input,
.settings-row select {
  flex: 1;
  min-width: 120px;
  margin: 0;
}
.settings-divider {
  border: none;
  border-top: 1px solid #eee;
  margin: 16px 0;
}
.settings-danger-btn {
  background: #ffcdd2;
  color: #b71c1c;
  font-weight: bold;
  border: 1px solid #ef9a9a;
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  width: 100%;
}
.settings-modal-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.settings-modal-title h3 { margin: 0; }
.settings-close-x {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #888;
  padding: 0 4px;
  line-height: 1;
  width: auto;
}

/* ===== WIZARD ===== */
#wizardModal .popup-content {
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}
.wiz-progress {
  background: #e0e0e0;
  border-radius: 4px;
  height: 6px;
  margin-bottom: 6px;
  overflow: hidden;
}
.wiz-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #FF8C42, #e06a1a);
  border-radius: 4px;
  transition: width .4s ease;
}
.wiz-step-label {
  font-size: 11px;
  color: #aaa;
  margin-bottom: 20px;
  display: block;
}
.wiz-step { display: none; }
.wiz-step.wiz-active { display: block; }
.wiz-question {
  font-size: 18px;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 18px;
  line-height: 1.4;
}
.wiz-hint {
  font-size: 13px;
  color: #888;
  margin-top: -10px;
  margin-bottom: 14px;
}
.wiz-choice-row {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}
.wiz-choice-btn {
  flex: 1;
  padding: 14px 10px;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  background: #fff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  text-align: center;
  line-height: 1.4;
}
.wiz-choice-btn:hover, .wiz-choice-btn.wiz-selected {
  border-color: #FF8C42;
  background: #fff3e0;
  color: #e06a1a;
}
.wiz-nav {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  position: sticky;
  bottom: 0;
  background: #fff;
  padding-top: 10px;
}
.wiz-closures-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}
.wiz-closures-grid label {
  font-size: 12px;
  color: #666;
  margin-bottom: 2px;
  display: block;
}
.wiz-closures-grid input {
  margin: 0;
  font-size: 13px;
  padding: 6px;
}
.wiz-check-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  border-radius: 10px;
  background: #f9f9f9;
  border: 1px solid #eee;
  margin-bottom: 10px;
  cursor: pointer;
}
.wiz-check-row input[type=checkbox] {
  width: 18px;
  height: 18px;
  margin: 0;
  flex-shrink: 0;
  cursor: pointer;
}
.wiz-check-row span { font-size: 14px; font-weight: 500; }
.wiz-summary {
  background: #f1f8e9;
  border: 1px solid #aed581;
  border-radius: 10px;
  padding: 14px;
  font-size: 13px;
  line-height: 1.8;
  margin-bottom: 16px;
}
.wiz-summary b { color: #33691e; }
</style>
</head>

<body>
<div class="top-nav-bar">
  <button class="menu-btn" onclick="goMenu()">‚¨Ö Retour au menu</button>
  <button class="kitsune-btn" onclick="window.location.href='../fox/index.html'" title="Ouvrir FOX Engine">ü¶ä Kitsune</button>
</div>

  <div id="exerciseAlert" style="
  display:none;
  max-width:900px;
  margin:10px auto;
  background:#fff3cd;
  border:1px solid #ffeeba;
  color:#856404;
  padding:12px;
  border-radius:8px;
  font-weight:bold;
  text-align:center;
">
  ‚ö†Ô∏è Action requise : D√©finissez votre date de d√©but d'exercice dans la Configuration pour activer le calendrier.
</div>


<div class="popup" id="popupNotice">
  <div class="popup-content" style="max-width:800px;max-height:80vh;overflow:auto;">
    <h3>üìò Notice utilisateur ‚Äì Compteur annuel d'heures</h3>

    <p>
      Cet outil permet de suivre et d'estimer les heures de travail,
      les heures suppl√©mentaires, les r√©cup√©rations et les absences
      dans le cadre d'un <b>compteur annuel</b>.
    </p>

    <hr>

    <h4>üóìÔ∏è Principe g√©n√©ral</h4>
    <p>
      Le suivi est organis√© par exercice annuel, d√©coup√© en p√©riodes
      comptables. Les calculs sont r√©alis√©s semaine par semaine,
      puis cumul√©s sur l'ann√©e.
    </p>

    <h4>‚è±Ô∏è Base hebdomadaire</h4>
    <p>
      La base hebdomadaire (ex : 35h) repr√©sente une semaine compl√®te
      th√©orique avant prise en compte des absences, r√©cup√©rations
      et jours f√©ri√©s.
    </p>

    <h4>‚ùå Absences</h4>
    <p>
      Les absences correspondent √† du temps non travaill√©.
      Elles r√©duisent le volume d'heures attendues dans la semaine
      et ne g√©n√®rent pas d'heures suppl√©mentaires.
    </p>

    <h4>üîÅ R√©cup√©rations</h4>
    <p>
      Les r√©cup√©rations sont des heures pr√©c√©demment travaill√©es,
      reprises ult√©rieurement sous forme de repos.
    </p>

    <p>
      <b>Dans cet outil, les r√©cup√©rations sont assimil√©es √† du temps
      non travaill√© et r√©duisent le volume hebdomadaire de r√©f√©rence
      dans le cadre d'un compteur annuel.</b>
    </p>

    <h4>‚ûï Heures suppl√©mentaires</h4>
    <p>
      Les heures suppl√©mentaires sont d√©clench√©es uniquement
      apr√®s d√©passement de l'√©quivalent de 35 heures
      r√©ellement travaill√©es sur la semaine.
    </p>

    <ul>
      <li>36·µâ √† 43·µâ heure : majoration 25 %</li>
      <li>Au-del√† : majoration 50 %</li>
    </ul>

    <h4>üìÜ P√©riodes et cl√¥tures</h4>
    <p>
      Les p√©riodes se terminent le dimanche.
      La p√©riode suivante d√©bute automatiquement le lundi.
    </p>

 <h4>üîí Verrouillage de la configuration</h4>
<p>
  Il est possible de verrouiller les param√®tres g√©n√©raux
  (date de d√©but, base hebdomadaire, cl√¥ture annuelle)
  afin d'√©viter toute modification involontaire.
</p>
    <h4>üíæ Sauvegarde</h4>
    <p>
      Les donn√©es sont enregistr√©es localement sur l'appareil utilis√©.
      Il est fortement recommand√© d'effectuer des exports r√©guliers
      pour s√©curiser le suivi annuel.
    </p>

    <hr>

    <p style="font-size:12px;color:#777">
      Cette notice est fournie √† titre informatif.
      L'outil ne constitue pas un logiciel de paie
      et ne se substitue pas aux documents officiels de l'employeur.
    </p>
<hr>
<button onclick="closeNotice()">Fermer</button>
  </div>
</div>
<h1>Compteur Heures Sup</h1>
<p style="text-align:center">

</p>
<p style="text-align:center">
  Exercice : <b id="activeYearLabel"></b>
  <button onclick="switchYear()">üìÅ Changer</button>
</p>

<!-- ========== BOUTON SETTINGS (remplace <details class="section">) ========== -->
<button id="openSettingsBtn" onclick="openSettingsModal()">
  ‚öôÔ∏è Configuration &amp; R√©glages
  <span style="float:right;opacity:.6;font-weight:400;font-size:13px">Appuyer pour ouvrir ‚Ä∫</span>
</button>

<div id="activePeriodBanner" style="
  max-width:900px;
  margin:10px auto;
  background:#e3f2fd;
  border:1px solid #90caf9;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
  font-weight:bold;
">
</div>
<div class="calendar-wrapper main-zone">
<div class="month-nav">
<select id="monthSelect"></select>
<select id="yearSelect"></select>
</div>

<div class="weekdays">
<div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div>
<div class="weekday">Jeu</div><div class="weekday">Ven</div><div class="weekday">Sam</div><div class="weekday">Dim</div>
</div>
<div class="calendar" id="calendar"></div>
</div>
<div style="
  max-width:900px;
  margin:15px auto;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:space-between;
">

 <div style="display:flex; gap:10px; flex-wrap:wrap;">
  <button onclick="exportJSON()" style="
    background:#e8f5e9;
    border:1px solid #2e7d32;
    font-weight:bold;
  ">
    üíæ Sauvegarde dans un fichier
  </button>
</div>
<div id="saveBadges" style="
  font-size:13px;
  color:#2e7d32;
  margin-top:6px;
  width:100%;
">
  <span id="autoSaveBadge">üü¢ Dans l'application : ‚Äî</span><br>
  <span id="fileSaveBadge">üíæ Sauvegarde fichier : ‚Äî</span>
</div>
  <span style="
    font-size:13px;
    color:#2e7d32;
    align-self:center;
  ">
    Sauvegarde automatique dans l'application ¬∑ Sauvegarde fichier recommand√©e
  </span>

</div>
<div class="totaux main-zone" id="totaux"></div>

<div class="popup" id="popup">
<div class="popup-content">
  <div class="sheet-handle"></div>
<h3 id="popupDate"></h3>

<fieldset class="block plus">
  <legend>‚ûï Heures suppl√©mentaires</legend>
  <button onclick="addExtra(0.25)">+15 min</button>
  <button onclick="addExtra(0.5)">+30 min</button>
  <button onclick="addExtra(1)">+1 h</button>
  <button onclick="addExtra(2)">+2 h</button>
  <input id="manualExtra" type="number" step="0.25">
</fieldset>

<fieldset class="block minus">
  <legend>‚ûñ R√©cup√©ration</legend>
  <button onclick="addRecup(0.25)">-15 min</button>
  <button onclick="addRecup(0.5)">-30 min</button>
  <button onclick="addRecup(1)">-1 h</button>
  <input id="manualRecup" type="number" step="0.25">
</fieldset>

<fieldset class="block absence">
  <legend>‚ùå Absence</legend>
  <label>
    <input type="checkbox" id="isAbsent"> Jour d'absence
  </label>
  <input id="absentHours" type="number" step="0.25">
</fieldset>

<div class="popup-actions">
  <button onclick="saveManual()">Valider</button>

  <button onclick="resetDay()" style="background:#c62828;color:#fff">
    üóëÔ∏è Supprimer les heures du jour
  </button>

  <button onclick="closePopup()">Annuler</button>
</div>
</div>
</div>

<div class="popup" id="popupJSON">
<div class="popup-content">
<h3 id="jsonTitle"></h3>
<textarea id="jsonArea" style="width:100%;height:200px"></textarea>
<button onclick="confirmImportJSON()">Importer</button>
<button onclick="closeJSONPopup()">Fermer</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ===== S√âCURIT√â / STABILIT√â =====
let APP_CRASHED = false;
let RECOVERY_MODE = false;
let DEBUG_MODE = true;
document.querySelectorAll('.popup').forEach(p=>{
  p.addEventListener('click', e=>{
    if(e.target === p && p.id === "popup"){
      closePopup();
    }
  });
});
let midnightTimer = null
function enterRecoveryMode(source, error){
  if(RECOVERY_MODE) return;

  RECOVERY_MODE = true;
  APP_CRASHED = true;

  localStorage.setItem(
    "APP_CRASH_STATE",
    JSON.stringify({
      at: new Date().toISOString(),
      source,
      message: String(error)
    })
  );

  alert(
    "‚ö†Ô∏è Une erreur est survenue.\n\n" +
    "L'application est pass√©e en mode r√©cup√©ration.\n" +
    "Aucune donn√©e n'a √©t√© supprim√©e."
  );
}
function simulateCrash(){
  console.warn("üí• Crash simul√© volontairement (DEBUG)");
  undefinedVariable.forceCrash();
}
function protectedCrash(){
  const code = prompt("üîí Zone prot√©g√©e\n\nEntrez le code :");
  if(code === null) return;

  if(code === "1234"){
    simulateCrash();
  } else {
    alert("‚ùå Code incorrect");
  }
}
function safe(fn, label = "fn"){
  return function(...args){
    try{
      return fn.apply(this, args);
    }catch(e){
      console.error("üí• CRASH:", label, e);
      enterRecoveryMode(label, e);
      return undefined;
    }
  }
}
window.onerror = function(msg, src, line, col, err){
  enterRecoveryMode("window.onerror", err || msg);
};

window.addEventListener("unhandledrejection", e=>{
  enterRecoveryMode("promise", e.reason);
});
function goMenu() {
    localStorage.removeItem("lastApp");
    window.location.href = "../menu.html";
    }
function autoSwitchPeriodAtMidnight(){
  const now = new Date();

  const nextMidnight = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate() + 1,
    0, 0, 0, 0
  );

  const delay = nextMidnight - now;

  if(midnightTimer){
    clearTimeout(midnightTimer);
  }

  midnightTimer = setTimeout(() => {
    if (typeof buildPeriods === "function") buildPeriods();
    if (typeof update === "function") update();
    showToast();
    autoSwitchPeriodAtMidnight();
  }, delay);
}

// ===== MULTI-ANN√âE =====
let currentSuffix = localStorage.getItem("ACTIVE_YEAR_SUFFIX") || new Date().getFullYear();
document.getElementById("activeYearLabel").textContent = currentSuffix;

function resetCurrentExercise(){
  if(!confirm("‚ö†Ô∏è R√©initialiser compl√®tement l'exercice " + currentSuffix + " ?\n\nToutes les donn√©es seront supprim√©es.")) {
    return;
  }
createSnapshot("before_reset_exercise");
  const suffix = currentSuffix;

  const keys = [
    "DATA_REPORT_",
    "CLOSURES_REPORT_",
    "REPORTS_REPORT_",
    "PERIOD_META_REPORT_",
    "ANNUAL_DATE_",
    "SPECIAL_DAYS_",
    "EXERCISE_START_"
  ];

  keys.forEach(prefix => {
    localStorage.removeItem(prefix + suffix);
  });

  alert("‚úÖ Exercice " + suffix + " remis √† z√©ro");
  location.reload();
}
function resetDay(){
  if(!selectedDate) return;

  if(!confirm("‚ùå Supprimer toutes les donn√©es de cette journ√©e ?")){
    return;
  }

  delete data[selectedDate];

  save();
  closePopup();
}
function checkExerciseStartAlert(){
  const alertBox = document.getElementById("exerciseAlert")
  if(!exerciseStart){
    alertBox.style.display = "block"
  } else {
    alertBox.style.display = "none"
  }
}
function switchYear(){
  openYearsPopup()
}
function openYearsPopup(){
  const box = document.getElementById("yearsList");
  if(!box) return;

  box.innerHTML = "";
  const years = getExistingYears()

  if(years.length === 0){
    box.innerHTML = "<i>Aucun exercice existant</i>"
  } else {
    years.forEach(y=>{
      const btn = document.createElement("button")
      btn.textContent = y + (String(y) === String(currentSuffix) ? " (actif)" : "")
      btn.onclick = () => {
        localStorage.setItem("ACTIVE_YEAR_SUFFIX", y)
        location.reload()
      }
      box.appendChild(btn)
    })
  }

  document.getElementById("popupYears").style.display = "flex"
}
function saveManual(){
  if(!selectedDate) return

  if(!data[selectedDate]){
    data[selectedDate] = { extra:0, recup:0, absent:0 }
  }

  data[selectedDate].extra = Number(manualExtra.value) || 0
  data[selectedDate].recup = Number(manualRecup.value) || 0

  if(isAbsent.checked){
    data[selectedDate].absent =
      Number(absentHours.value) || DAILY_WORK_HOURS
  } else {
    data[selectedDate].absent = 0
  }

  save()
  closePopup()
}
function closeYearsPopup(){
  document.getElementById("popupYears").style.display = "none"
}

function confirmSwitchYear(){
  const val = document.getElementById("newYearInput").value
  if(!val) return

  const baseKey = "DATA_REPORT_" + val
  if(!localStorage.getItem(baseKey)){
    localStorage.setItem(baseKey, JSON.stringify({}))
    localStorage.setItem("CLOSURES_REPORT_" + val, JSON.stringify([]))
    localStorage.setItem("REPORTS_REPORT_" + val, JSON.stringify({}))
    localStorage.setItem("PERIOD_META_REPORT_" + val, JSON.stringify({}))
  }

  localStorage.setItem("ACTIVE_YEAR_SUFFIX", val)
  location.reload()
}
function addRecup(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}

  const newVal =
    Math.round((data[selectedDate].recup + h) * 4) / 4

  data[selectedDate].recup = ALLOW_RECUP_FREE
    ? newVal
    : Math.min(newVal, data[selectedDate].extra)

  save()
  closePopup()
}
function addExtra(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}
  data[selectedDate].extra =
    Math.round((data[selectedDate].extra + h) * 4) / 4
  save()
  closePopup()
}
function getExistingYears(){
  const years = new Set()

  for(let i=0; i<localStorage.length; i++){
    const key = localStorage.key(i)
    if(key.startsWith("DATA_REPORT_")){
      years.add(key.replace("DATA_REPORT_", ""))
    }
  }

  return Array.from(years).sort()
}
// ===== STOCKAGE DYNAMIQUE =====
const STORAGE = {
  data: "DATA_REPORT_" + currentSuffix,
  closures: "CLOSURES_REPORT_" + currentSuffix,
  reports: "REPORTS_REPORT_" + currentSuffix,
  annualDate: "ANNUAL_DATE_" + currentSuffix,
  specialDays: "SPECIAL_DAYS_" + currentSuffix,
  exerciseStart: "EXERCISE_START_" + currentSuffix
};

STORAGE.periodMeta = "PERIOD_META_REPORT_" + currentSuffix;

// ===== DONN√âES =====

let data = JSON.parse(localStorage.getItem(STORAGE.data)) || {};
let closures = JSON.parse(localStorage.getItem(STORAGE.closures)) || [];
let reports = JSON.parse(localStorage.getItem(STORAGE.reports)) || {};

let annualDate = localStorage.getItem(STORAGE.annualDate) || "";
let annualRate =
  Number(localStorage.getItem("ANNUAL_RATE_" + currentSuffix)) || 10;
let specialDays = JSON.parse(localStorage.getItem(STORAGE.specialDays)) || {};
let exerciseStart = localStorage.getItem(STORAGE.exerciseStart) || "";
let periodMeta = JSON.parse(localStorage.getItem(STORAGE.periodMeta)) || {}
let BASE_HEBDO =
  Number(localStorage.getItem("BASE_HEBDO_" + currentSuffix)) || 35;
  let AUTO_FERIE =
  localStorage.getItem("AUTO_FERIE_" + currentSuffix) === "true";
const DAILY_WORK_HOURS = 7;
const ALLOW_RECUP_FREE = true;
const months=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"]
const monthSelect=document.getElementById("monthSelect")
const yearSelect=document.getElementById("yearSelect")
const periodSelect=document.getElementById("periodSelect")
const calendar=document.getElementById("calendar")
const periodInfo=document.getElementById("periodInfo")
const totaux=document.getElementById("totaux")
const popup = document.getElementById("popup")
const popupDate = document.getElementById("popupDate")
const manualExtra = document.getElementById("manualExtra")
const manualRecup = document.getElementById("manualRecup")
const isAbsent = document.getElementById("isAbsent")
const absentHours = document.getElementById("absentHours")

const popupJSON = document.getElementById("popupJSON")
const jsonTitle = document.getElementById("jsonTitle")
const jsonArea = document.getElementById("jsonArea")
  
let view=new Date()
let viewMonth=view.getMonth()
let viewYear=view.getFullYear()
let selectedDate=""
let currentPeriodIndex=0
function dateKeyLocal(d){
  const y = d.getFullYear()
  const m = String(d.getMonth() + 1).padStart(2, "0")
  const day = String(d.getDate()).padStart(2, "0")
  return `${y}-${m}-${day}`
}
function getBaseStartDate(){
  if(!exerciseStart){
    return null;
  }
  return new Date(exerciseStart);
}


function initSelectors(){
monthSelect.innerHTML=""
months.forEach((m,i)=>{
const o=document.createElement("option")
o.value=i;o.textContent=m
if(i===viewMonth)o.selected=true
monthSelect.appendChild(o)
})
yearSelect.innerHTML=""
for(let y=viewYear-2;y<=2050;y++){
const o=document.createElement("option")
o.value=y;o.textContent=y
if(y===viewYear)o.selected=true
yearSelect.appendChild(o)
}
}

function openClosures(){
const box=document.getElementById("closuresInputs")
box.innerHTML=""
for(let i=0;i<12;i++){
const input=document.createElement("input")
input.type="date"
input.value=closures[i]||""
box.appendChild(input)
}
document.getElementById("popupClosures").style.display="flex"
}

function closeClosures(){document.getElementById("popupClosures").style.display="none"}
function forceSunday(dateStr){
  if(!dateStr) return dateStr;
  const d = new Date(dateStr);
  const day = d.getDay();
  if(day === 0) return dateStr;
  d.setDate(d.getDate() - day);
  return d.toISOString().slice(0,10);
}
function saveClosures(){
  let adjusted = false

  const inputs = [...document.querySelectorAll("#closuresInputs input")]

  closures = inputs
    .map(i => {
      const original = i.value
      const forced = forceSunday(i.value)
      if(original && original !== forced) adjusted = true
      return forced
    })
    .filter(v => v)
    .sort()

  localStorage.setItem(STORAGE.closures, JSON.stringify(closures))

  if(adjusted){
    alert("‚ÑπÔ∏è Toute cl√¥ture doit √™tre un dimanche.\nLes dates saisies ont √©t√© automatiquement ajust√©es.")
  }

  buildPeriods()
  closeClosures()
}
function deletePeriod(i){
  if(!confirm("‚ùå Supprimer cette p√©riode ? Elle sera ignor√©e mais conserv√©e.")) return;

  periodMeta[i] = { status: "deleted" }
  localStorage.setItem(STORAGE.periodMeta, JSON.stringify(periodMeta))
if (typeof update === "function") update();
}
function buildPeriods(){
  const base = getBaseStartDate();
  if(!base){
    periodSelect.innerHTML = "";
    if (typeof update === "function") update();
    return;
  }

  periodSelect.innerHTML = "";

  let start = new Date(base);
  let today = new Date();
  today.setHours(0,0,0,0);

  let foundIndex = null;

  closures.forEach((c, i) => {
    const end = new Date(c);
    end.setHours(0,0,0,0);

    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${start.toLocaleDateString()} ‚Üí ${end.toLocaleDateString()}`;
    periodSelect.appendChild(opt);

    if (today >= start && today <= end) {
      foundIndex = i;
    }

    start = new Date(end);
    start.setDate(start.getDate() + 1);
  });

if (closures.length === 0) {
  foundIndex = 0;
} else if (foundIndex === null) {
  foundIndex = closures.length - 1;
}

foundIndex = Math.max(0, foundIndex);

currentPeriodIndex = foundIndex;
periodSelect.selectedIndex = foundIndex;

if (typeof update === "function") update();
}

function toggleConfigLock(){
  const key = "CONFIG_LOCK_" + currentSuffix;
  const locked = localStorage.getItem(key) === "true";
  localStorage.setItem(key, !locked);
  applyConfigLock();
}

function applyConfigLock(){
  const locked =
    localStorage.getItem("CONFIG_LOCK_" + currentSuffix) === "true";

  document.querySelectorAll(
    "#exerciseStartInput, #baseHebdoInput, #annualDateInput"
  ).forEach(el => el.disabled = locked);

  const info = document.getElementById("configLockInfo");
  if(info){
    info.textContent = locked
      ? "üîí Configuration verrouill√©e"
      : "üîì Configuration modifiable";
  }
}
function getCurrentPeriod(){
  const base = getBaseStartDate();
  if(!base) return null;

  let start = base;

  for(let i = 0; i <= closures.length; i++){
    const end = i < closures.length ? new Date(closures[i]) : new Date(2099,11,31)
    if(i === currentPeriodIndex){
      return { start, end, index: i }
    }
    start = new Date(end)
    start.setDate(start.getDate() + 1)
  }
  return null
}
function ensureReportsUpTo(index){
  for(let i = 0; i < index; i++){
    if(reports[i] === undefined){
      const savedIndex = currentPeriodIndex
      currentPeriodIndex = i
      calculate()
      currentPeriodIndex = savedIndex
    }
  }
}
function generateCalendar(){
  calendar.innerHTML = ""

  const firstDay = new Date(viewYear, viewMonth, 1).getDay()
  const offset = firstDay === 0 ? 6 : firstDay - 1
  const days = new Date(viewYear, viewMonth + 1, 0).getDate()

  for(let i = 0; i < offset; i++){
    calendar.appendChild(document.createElement("div"))
  }

  const period = getCurrentPeriod()
  let pStart = null, pEnd = null

  if(period){
    pStart = new Date(period.start)
    pEnd = new Date(period.end)
    pStart.setHours(0,0,0,0)
    pEnd.setHours(0,0,0,0)
  }

  for(let d = 1; d <= days; d++){
    const key = `${viewYear}-${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`
    const div = document.createElement("div")
    div.className = "day"

    if(period){
      const dk = new Date(key)
      if(pStart && dk >= pStart && dk <= pEnd){
        div.classList.add("in-period")
      }
    }

    const day = data[key] || { extra:0, recup:0, absent:0 }
    let html = `<strong>${d}</strong>`

    if(day.extra){
      html += `<small style="color:#1976d2">+${day.extra}h</small>`
    }

    if(day.recup){
      html += `<small style="color:#ef6c00">-${day.recup}h</small>`
    }

    if (specialDays[key] === "ferie") {
      html += `<small style="color:#0d47a1;font-weight:bold">üéå F√©ri√©</small>`
      div.style.background = "#e3f2fd"
      div.style.border = "2px dashed #1976d2"
    }
    else if (day.absent) {
      html += `<small style="color:#c62828;font-weight:bold">ABS ${day.absent}h</small>`
      div.style.background = "#ffebee"
      div.style.border = "2px solid #c62828"
    }

    div.innerHTML = html

    if(key === dateKeyLocal(new Date())){
      div.classList.add("today")
    }

    div.onclick = () => openPopup(key)
    calendar.appendChild(div)
  }
}
function getLastValidReport(index) {
  for (let i = index - 1; i >= 0; i--) {
    if (reports[i] !== undefined && reports[i] !== null) {
      return Number(reports[i]) || 0;
    }
  }
  return 0;
}
function calculate(){

  const period = getCurrentPeriod();
  if(!period){
    totaux.innerHTML = `
      <div style="background:#fff3cd;border:1px solid #ffeeba;padding:12px;border-radius:8px;color:#856404">
        ‚ÑπÔ∏è D√©finissez une date de d√©but d'exercice et des cl√¥tures
        pour activer les calculs.
      </div>
    `;
    return;
  }

  if(periodMeta[period.index]?.status === "deleted"){
    totaux.innerHTML = "<i>‚ùå Cette p√©riode est supprim√©e</i>";
    return;
  }

  let weeks = {};
  let absences = {};
  let recups = {};
  let totalRecup = 0;
  let details = [];
  let h25 = 0;
  let h50 = 0;

  ensureReportsUpTo(period.index);
  const reportPrev = getLastValidReport(period.index);

  periodInfo.innerHTML = `
    <b>P√©riode :</b> ${period.start.toLocaleDateString()} ‚Üí
    ${period.end.getFullYear() === 2099 ? "en cours" : period.end.toLocaleDateString()}<br>
    <b>Report pr√©c√©dent :</b> ${reportPrev.toFixed(2)} h
  `;

  const pStart = new Date(period.start);
  const pEnd = new Date(period.end);
  pStart.setHours(0,0,0,0);
  pEnd.setHours(0,0,0,0);

if (AUTO_FERIE) {
  Object.entries(specialDays).forEach(([date, type]) => {
    if (type !== "ferie") return;

    const d = new Date(date);
    if (d < pStart || d > pEnd) return;

    const dow = d.getDay();
    if (dow === 0 || dow === 6) return;

    if (!data[date] || !data[date].absent) {
      const iso = dow === 0 ? 7 : dow;
      const monday = new Date(d);
      monday.setDate(monday.getDate() - (iso - 1));
      const weekKey = dateKeyLocal(monday);

      absences[weekKey] =
        (absences[weekKey] || 0) + DAILY_WORK_HOURS;
    }
  });
}

  Object.entries(data).forEach(([date, v]) => {
    const [y,m,d] = date.split("-").map(Number);
    const dayDate = new Date(y, m-1, d);
    const dow = dayDate.getDay();

    if(dayDate < pStart || dayDate > pEnd) return;

    const isoDay = dow === 0 ? 7 : dow;
    const monday = new Date(dayDate);
    monday.setDate(monday.getDate() - (isoDay - 1));

    if(monday < pStart || monday > pEnd) return;

    const weekKey = dateKeyLocal(monday);

    let absentHours = v.absent || 0;

    weeks[weekKey] = (weeks[weekKey] || 0) + (v.extra || 0);

    if(dow !== 0 && dow !== 6){
      absences[weekKey] = (absences[weekKey] || 0) + absentHours;
    }

    recups[weekKey] = (recups[weekKey] || 0) + (v.recup || 0);
    totalRecup += v.recup || 0;
  });

  Object.entries(weeks).forEach(([week, extra]) => {
    const absent = absences[week] || 0;
    const recup = recups[week] || 0;

    const base = Math.max(0, BASE_HEBDO - absent - recup);
    const total = base + extra;

    let w25 = 0;
    let w50 = 0;

    if(total > BASE_HEBDO){
      w25 = Math.min(total, BASE_HEBDO + 8) - BASE_HEBDO;
    }
    if(total > BASE_HEBDO + 8){
      w50 = total - (BASE_HEBDO + 8);
    }

    w25 = Math.max(0, w25);
    w50 = Math.max(0, w50);

    h25 += w25;
    h50 += w50;

    const [y,m,d] = week.split("-");
    const wd = new Date(y, m-1, d);
    details.push(
      `Semaine du ${wd.toLocaleDateString()} : ${w25.toFixed(2)}h √† 25% / ${w50.toFixed(2)}h √† 50%`
    );
  });

  const brut25 = h25 * 1.25;
  const brut50 = h50 * 1.5;
  const brut = brut25 + brut50 + reportPrev;
  const net = brut - totalRecup;

  reports[period.index] = net;
  localStorage.setItem(STORAGE.reports, JSON.stringify(reports));

  totaux.innerHTML = `
    <details class="calc-details">
      <summary>üìä D√©tails des calculs</summary>
      <div class="breakdown">
        ${details.join("<br>")}
        <hr>
        25% : ${h25}h √ó 1,25 = ${brut25.toFixed(2)} h<br>
        50% : ${h50}h √ó 1,50 = ${brut50.toFixed(2)} h<br>
        Report pr√©c√©dent : ${reportPrev.toFixed(2)} h
      </div>
    </details>
    <hr>
    <b>Solde brut :</b> ${brut.toFixed(2)} h<br>
    R√©cup : ${totalRecup.toFixed(2)} h<br>
    <b>Solde net :</b> ${net.toFixed(2)} h
  `;

  const rateContainer = document.getElementById("rateContainer");
  rateContainer.innerHTML = "";

  if(shouldShowAnnualClosure()){
    rateContainer.innerHTML = `
      <div style="background:#fff3e0;padding:10px;border-radius:6px;border:1px solid #ff9800;margin-top:10px;">
        <label><b>Taux horaire (‚Ç¨)</b></label>
        <input
          type="number"
          id="hourlyRateInput"
          step="0.5"
          value="${annualRate}"
        >
      </div>
    `;

    const rateInput = document.getElementById("hourlyRateInput");
    rateInput.oninput = () => {
      const v = Number(rateInput.value);
      annualRate = isNaN(v) ? 10 : v;
      localStorage.setItem("ANNUAL_RATE_" + currentSuffix, annualRate);
      calculate();
    };

    const rate = annualRate || 10;
    const paiement = net * rate;

    totaux.innerHTML += `
      <hr>
      <div style="background:#e8f5e9;padding:15px;border:2px solid #2e7d32;border-radius:8px;">
        <h3 style="margin:0;color:#2e7d32;">üéØ Cl√¥ture Annuelle</h3>
        <b>Paiement (${rate}‚Ç¨/h) :</b> ${paiement.toFixed(2)} ‚Ç¨
      </div>
    `;
 }
}
function openNotice(){
  document.getElementById("popupNotice").style.display = "flex";
}

function closeNotice(){
  document.getElementById("popupNotice").style.display = "none";
}
function openPopup(date){
  selectedDate = date

  if(!exerciseStart){
    console.warn("Date de d√©but d'exercice non d√©finie")
  }

if (
  specialDays[date] === "ferie" &&
  !AUTO_FERIE
) {
  if (!data[date]) data[date] = {extra:0, recup:0, absent:0}
  data[date].absent = DAILY_WORK_HOURS
}

  const d = data[date] || {extra:0, recup:0, absent:0}

  popupDate.textContent = date
  manualExtra.value = d.extra
  manualRecup.value = d.recup
  absentHours.value = d.absent || 0
  isAbsent.checked = (d.absent || 0) > 0
document.body.style.overflow = "hidden";
  popup.style.display = "flex"
}
function closePopup(){
  document.getElementById("popup").style.display = "none";
  const hadDate = selectedDate;
  selectedDate = "";
  document.body.style.overflow = "";
  if (hadDate && typeof update === "function") update();
}


function save(){
  localStorage.setItem(STORAGE.data, JSON.stringify(data));

  const stamp = new Date().toISOString();
  localStorage.setItem("AUTO_SAVE_DATE_" + currentSuffix, stamp);

  updateSaveBadges();
}

function isIOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent)}
function createSnapshot(label){
  const key = "SNAPSHOT_" + Date.now();
  const payload = {
    label,
    date: new Date().toISOString(),
    data,
    closures,
    reports,
    periodMeta,
    exerciseStart,
    annualDate,
    specialDays,
    BASE_HEBDO,
    annualRate
  };

  localStorage.setItem(key, JSON.stringify(payload));

  const snaps = Object.keys(localStorage)
    .filter(k => k.startsWith("SNAPSHOT_"))
    .sort();

  while(snaps.length > 5){
    localStorage.removeItem(snaps.shift());
  }
}
function exportJSON(){
  createSnapshot("before_export");
  const payload = {
    version: 1,
    exercise: currentSuffix,
    data,
    closures,
    reports,
    periodMeta,
    exerciseStart,
    annualDate,
    specialDays,
    BASE_HEBDO,
    annualRate
  }
  const json = JSON.stringify(payload, null, 2)
  const blob = new Blob([json], { type: "application/json" })
  const filename = `heures_sup_${currentSuffix}.json`

  if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename)] })) {
  const stamp = new Date().toISOString()
  localStorage.setItem("FILE_SAVE_DATE_" + currentSuffix, stamp)
  updateSaveBadges()

  const file = new File([blob], filename, { type: "application/json" })
  navigator.share({
    files: [file],
    title: "Sauvegarde heures suppl√©mentaires"
  })
  return
}

  const url = URL.createObjectURL(blob)
  const a = document.createElement("a")
  a.href = url
  a.download = filename
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  const stamp = new Date().toISOString()
localStorage.setItem("FILE_SAVE_DATE_" + currentSuffix, stamp)
updateSaveBadges()
}


function importJSON(){
if(isIOS()){
jsonTitle.textContent = "Collez le texte JSON (Import)"
jsonArea.value = ""
popupJSON.style.display = "flex"
}else{
const input = document.createElement("input")
input.type = "file"
input.accept = ".json"
input.onchange = e => {
const reader = new FileReader()
reader.onload = () => loadJSON(reader.result)
reader.readAsText(e.target.files[0])
}
input.click()
}
}
function updateSaveBadges(){
  const autoEl = document.getElementById("autoSaveBadge")
  const fileEl = document.getElementById("fileSaveBadge")

  if(!autoEl || !fileEl) return

  const auto = localStorage.getItem("AUTO_SAVE_DATE_" + currentSuffix)
  const file = localStorage.getItem("FILE_SAVE_DATE_" + currentSuffix)

  autoEl.textContent = auto
  ? "üü¢ Dans l'application : " + new Date(auto).toLocaleString()
  : "üü¢ Dans l'application : ‚Äî"

fileEl.textContent = file
  ? "üíæ Sauvegarde fichier : " + new Date(file).toLocaleString()
  : "üíæ Sauvegarde fichier : ‚Äî"
  }
function confirmImportJSON(){loadJSON(jsonArea.value);closeJSONPopup()}

function loadJSON(text){
  let obj;

  try {
    obj = JSON.parse(text);
  } catch(e){
    alert("‚ùå JSON invalide");
    return;
  }

  if(obj.version !== 1){
    alert("‚ùå Version de sauvegarde incompatible");
    return;
  }

  if(obj.exercise && String(obj.exercise) !== String(currentSuffix)){
    const ok = confirm(
      `‚ö†Ô∏è Ce fichier appartient √† l'exercice ${obj.exercise}.\n\n` +
      `Voulez-vous basculer automatiquement dessus ?`
    );
    if(!ok) return;

    localStorage.setItem("ACTIVE_YEAR_SUFFIX", obj.exercise);
    location.reload();
    return;
  }

  if(!obj.data || !obj.closures){
    alert("‚ùå Sauvegarde invalide ou incompl√®te");
    return;
  }

  if(!confirm(
    "‚ö†Ô∏è Cette action va remplacer les donn√©es de l'exercice en cours.\n\nContinuer ?"
  )){
    return;
  }
createSnapshot("before_import");
  data = obj.data;
  closures = obj.closures;
  reports = obj.reports || {};
  periodMeta = obj.periodMeta || {};
  exerciseStart = obj.exerciseStart || "";
  annualDate = obj.annualDate || "";
  specialDays = obj.specialDays || {};

  BASE_HEBDO = Number(obj.BASE_HEBDO) || 35;
  annualRate = Number(obj.annualRate) || 10;

  localStorage.setItem(STORAGE.data, JSON.stringify(data));
  localStorage.setItem(STORAGE.closures, JSON.stringify(closures));
  localStorage.setItem(STORAGE.reports, JSON.stringify(reports));
  localStorage.setItem(STORAGE.periodMeta, JSON.stringify(periodMeta));
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);
  localStorage.setItem(STORAGE.annualDate, annualDate);
  localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays));
  localStorage.setItem("BASE_HEBDO_" + currentSuffix, BASE_HEBDO);
  localStorage.setItem("ANNUAL_RATE_" + currentSuffix, annualRate);

  if (typeof update === "function") update();
  alert("‚úÖ Import complet r√©ussi");
}

function closeJSONPopup(){popupJSON.style.display = "none"}

async function importFeries(){
  const baseYear = Number(currentSuffix);
  const years = [baseYear - 1, baseYear, baseYear + 1];

  if(!confirm(
    `Importer les jours f√©ri√©s officiels pour ${years.join(", ")} ?`
  )) return;

  try{
    for(const year of years){
      const res = await fetch(
        `https://calendrier.api.gouv.fr/jours-feries/metropole/${year}.json`
      );
      const feries = await res.json();

      Object.keys(feries).forEach(date=>{
        if(!specialDays[date]){
          specialDays[date] = "ferie";
        }
      });
    }

    localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays));
    localStorage.setItem(STORAGE.data, JSON.stringify(data));

    if (typeof update === "function") update();
    alert("‚úÖ Jours f√©ri√©s import√©s (N-1 / N / N+1)");
  }catch(e){
    alert("‚ùå Impossible d'importer les jours f√©ri√©s");
  }
}
function update(){
  checkExerciseStartAlert()
  generateCalendar()
  calculate()
  applyConfigLock()
  updateSaveBadges()
  const autoFerieToggle = document.getElementById("autoFerieToggle");
if(autoFerieToggle){
  autoFerieToggle.checked = AUTO_FERIE;
  autoFerieToggle.onchange = () => {
    AUTO_FERIE = autoFerieToggle.checked;
    localStorage.setItem(
      "AUTO_FERIE_" + currentSuffix,
      AUTO_FERIE
    );
    update();
  };
}

  const banner = document.getElementById("activePeriodBanner")
  const period = getCurrentPeriod()

  if(banner){
    if(period && exerciseStart){
      const start = period.start.toLocaleDateString()
      const end = period.end.getFullYear() === 2099
        ? "en cours"
        : period.end.toLocaleDateString()

      banner.innerHTML =
  `üìò P√©riode ${period.index + 1} : ${start} ‚Üí ${end}`;
    } else {
      banner.innerHTML = ""
    }
  }
}
monthSelect.onchange = () => {
  viewMonth = +monthSelect.value;
  if (typeof update === "function") update();
};

yearSelect.onchange = () => {
  viewYear = +yearSelect.value;
  if (typeof update === "function") update();
};
periodSelect.onchange = () => {
  currentPeriodIndex = +periodSelect.value;
  if (typeof update === "function") update();
  showToast();
};


const annualDateInput = document.getElementById("annualDateInput");
annualDateInput.value = annualDate;

annualDateInput.onchange = () => {
  annualDate = forceSunday(annualDateInput.value);
  annualDateInput.value = annualDate;
  localStorage.setItem(STORAGE.annualDate, annualDate);
};
const exerciseStartInput = document.getElementById("exerciseStartInput");
exerciseStartInput.value = exerciseStart;
const baseHebdoInput = document.getElementById("baseHebdoInput");
baseHebdoInput.value = BASE_HEBDO;

baseHebdoInput.oninput = () => {
  BASE_HEBDO = Number(baseHebdoInput.value) || 35;
  localStorage.setItem("BASE_HEBDO_" + currentSuffix, BASE_HEBDO);
  if (typeof update === "function") update();
};
exerciseStartInput.onchange = ()=>{
  exerciseStart = exerciseStartInput.value;
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);
  buildPeriods();
};

function exportMonthlyFullPDF(){
  createSnapshot("before_export");
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  const title = `Compteur annuel d'heures ‚Äì R√©capitulatif mensuel`
  const monthName = months[viewMonth]

  let y = 15
  pdf.setFontSize(14)
  pdf.text(title, 10, y)
  y += 10

  pdf.setFontSize(10)
  pdf.text(`Mois : ${monthName} ${viewYear}`, 10, y); y+=6
  pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`, 10, y); y+=6
const period = getCurrentPeriod();
if(period){
  pdf.text(
    "P√©riode comptable : p√©riode active au moment de l'export",
    10, y
  );
  y += 6;
}
  pdf.line(10, y, 200, y)
  y += 8

  let weeks = {}
  let absences = {}
  let recups = {}
  let feries = {}

  Object.entries(data).forEach(([date, v])=>{
    const d = new Date(date)
    if(d.getFullYear() !== viewYear || d.getMonth() !== viewMonth) return

    const day = d.getDay()
    const iso = day === 0 ? 7 : day
    const monday = new Date(d)
    monday.setDate(monday.getDate() - (iso - 1))
    const wk = dateKeyLocal(monday)

    weeks[wk] = (weeks[wk] || 0) + (v.extra || 0)
    recups[wk] = (recups[wk] || 0) + (v.recup || 0)

    if(day !== 0 && day !== 6){
      absences[wk] = (absences[wk] || 0) + (v.absent || 0)
    }

    if(specialDays[date] === "ferie"){
      feries[wk] = (feries[wk] || 0) + DAILY_WORK_HOURS
    }
  })

  let t25=0, t50=0, tRec=0

  Object.keys(weeks).sort().forEach(w=>{
    const base = Math.max(0, BASE_HEBDO - (absences[w]||0) - (recups[w]||0))
    const total = base + weeks[w]

    let h25 = 0, h50 = 0
    if(total > BASE_HEBDO) h25 = Math.min(total, BASE_HEBDO+8)-BASE_HEBDO
    if(total > BASE_HEBDO+8) h50 = total-(BASE_HEBDO+8)

    t25 += Math.max(0,h25)
    t50 += Math.max(0,h50)
    tRec += recups[w]||0

    pdf.text(
      `Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h 25% / ${h50.toFixed(2)}h 50%`,
      10, y
    )
    y+=6
    if(y>270){pdf.addPage();y=15}
  })

  y+=6
  pdf.line(10,y,200,y);y+=8
  pdf.text(`Total 25 % : ${t25.toFixed(2)} h`,10,y);y+=6
  pdf.text(`Total 50 % : ${t50.toFixed(2)} h`,10,y);y+=6
  pdf.text(`R√©cup√©rations : ${tRec.toFixed(2)} h`,10,y)

  y+=10
  pdf.setFontSize(8)
  pdf.text("Document informatif ‚Äì ne constitue pas un bulletin de paie.",10,y)

  pdf.save(`mensuel_${monthName}_${viewYear}.pdf`)
}
function exportAnnualPDF(){
  createSnapshot("before_export");
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  let y = 15

  const addHeader = (title) => {
    pdf.setFontSize(14)
    pdf.text(title, 10, y)
    y += 8
    pdf.setFontSize(10)
    pdf.text(`Exercice : ${currentSuffix}`, 10, y)
    y += 8
    pdf.line(10, y, 200, y)
    y += 6
  }

  addHeader("Compteur annuel d'heures ‚Äì Bilan annuel")

  let annualNet = 0

  closures.forEach((_, index) => {

    const period = (() => {
      let start = getBaseStartDate()
      for(let i=0;i<=closures.length;i++){
        const end = i < closures.length
          ? new Date(closures[i])
          : new Date(2099,11,31)
        if(i === index){
          return { start, end, index:i }
        }
        start = new Date(end)
        start.setDate(start.getDate()+1)
      }
      return null
    })()

    if(!period) return
    if(periodMeta[index]?.status === "deleted") return

    if(y > 230){
      pdf.addPage()
      y = 15
      addHeader("Suite ‚Äì Bilan annuel")
    }

    pdf.setFontSize(12)
    pdf.text(
      `üìò P√©riode ${index + 1} : ${period.start.toLocaleDateString()} ‚Üí ${
        period.end.getFullYear() === 2099 ? "en cours" : period.end.toLocaleDateString()
      }`,
      10, y
    )
    y += 6

    pdf.setFontSize(9)
    pdf.text(
  `Base hebdomadaire : ${BASE_HEBDO} h`,
  10, y
)
    y += 5

    let weeks = {}
    let absences = {}
    let recups = {}

    Object.entries(data).forEach(([date, v])=>{
      const d = new Date(date)
      if(d < period.start || d > period.end) return

      const day = d.getDay()
      const iso = day === 0 ? 7 : day
      const monday = new Date(d)
      monday.setDate(monday.getDate() - (iso - 1))
      const wk = dateKeyLocal(monday)

      weeks[wk] = (weeks[wk] || 0) + (v.extra || 0)
      recups[wk] = (recups[wk] || 0) + (v.recup || 0)

      if(day !== 0 && day !== 6){
        absences[wk] = (absences[wk] || 0) + (v.absent || 0)
      }
    })

    let p25 = 0, p50 = 0, pRec = 0

    Object.keys(weeks).sort().forEach(w=>{
      const base = Math.max(
        0,
        BASE_HEBDO - (absences[w]||0) - (recups[w]||0)
      )
      const total = base + weeks[w]

      let h25 = 0, h50 = 0
      if(total > BASE_HEBDO) h25 = Math.min(total, BASE_HEBDO+8)-BASE_HEBDO
      if(total > BASE_HEBDO+8) h50 = total-(BASE_HEBDO+8)

      p25 += Math.max(0,h25)
      p50 += Math.max(0,h50)
      pRec += recups[w]||0

      pdf.text(
        `‚Ä¢ Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h 25% / ${h50.toFixed(2)}h 50%`,
        12, y
      )
      y += 4

      if(y > 270){
        pdf.addPage()
        y = 15
      }
    })

    const reportPrev = getLastValidReport(index)
    const brut = p25*1.25 + p50*1.5 + reportPrev
    const net = brut - pRec

annualNet += net

    y += 4
    pdf.text(`Total 25 % : ${p25.toFixed(2)} h`, 12, y); y+=4
    pdf.text(`Total 50 % : ${p50.toFixed(2)} h`, 12, y); y+=4
    pdf.text(`R√©cup√©rations : ${pRec.toFixed(2)} h`, 12, y); y+=4
    pdf.text(`Solde net de p√©riode : ${net.toFixed(2)} h`, 12, y); y+=6

    pdf.line(10, y, 200, y)
    y += 6
  })

  if(y > 240){
    pdf.addPage()
    y = 15
  }

  pdf.setFontSize(14)
  pdf.text("üìä Synth√®se annuelle", 10, y)
  y += 10

  pdf.setFontSize(12)
  pdf.text(`Solde annuel net cumul√© : ${annualNet.toFixed(2)} h`, 10, y)
  y += 14

  pdf.setFontSize(10)
  pdf.text("Validation / Signature :", 10, y)
  y += 10
  pdf.rect(10, y, 90, 20)

  y += 30
  pdf.setFontSize(8)
  pdf.text(
  "Bilan annuel g√©n√©r√© automatiquement.\nDocument indicatif ‚Äì ne constitue pas un bulletin de paie.",
  10,
  y
)

pdf.save(`annuel_${currentSuffix}.pdf`)
}
function exportPeriodPDF(){
  createSnapshot("before_export");
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  const period = getCurrentPeriod()
  if(!period){
    alert("‚ùå Aucune p√©riode active")
    return
  }

  const title = "Compteur annuel d'heures ‚Äì R√©capitulatif de p√©riode"

  let y = 15
  pdf.setFontSize(14)
  pdf.text(title, 10, y)

  y += 10
  pdf.setFontSize(10)

  pdf.text(
  `P√©riode : ${period.start.toLocaleDateString()} ‚Üí ${
    period.end.getFullYear() === 2099
      ? "en cours"
      : period.end.toLocaleDateString()
  }`,
  10,
  y
);
y += 6;
  pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`, 10, y)

  y += 6
  y += 8
  pdf.line(10, y, 200, y)
  y += 6

  let weeks = {}
  let absences = {}
  let recups = {}
  let feries = {}

  Object.entries(data).forEach(([date, v])=>{
    const d = new Date(date)
    if(d < period.start || d > period.end) return

    const day = d.getDay()
    const isoDay = day === 0 ? 7 : day
    const monday = new Date(d)
    monday.setDate(monday.getDate() - (isoDay - 1))
    const wk = dateKeyLocal(monday)

    weeks[wk] = (weeks[wk] || 0) + (v.extra || 0)
    recups[wk] = (recups[wk] || 0) + (v.recup || 0)

    if(day !== 0 && day !== 6){
      absences[wk] = (absences[wk] || 0) + (v.absent || 0)
    }

    if(specialDays[date] === "ferie"){
      feries[wk] = (feries[wk] || 0) + DAILY_WORK_HOURS
    }
  })

  let total25 = 0
  let total50 = 0
  let totalRecup = 0

  Object.keys(weeks).sort().forEach(week=>{
    const base = Math.max(
      0,
      BASE_HEBDO - (absences[week] || 0) - (recups[week] || 0)
    )
    const total = base + weeks[week]

    let h25 = 0
    let h50 = 0

    if(total > BASE_HEBDO){
      h25 = Math.min(total, BASE_HEBDO + 8) - BASE_HEBDO
    }
    if(total > BASE_HEBDO + 8){
      h50 = total - (BASE_HEBDO + 8)
    }

    total25 += Math.max(0, h25)
    total50 += Math.max(0, h50)
    totalRecup += recups[week] || 0

    const d = new Date(week)
    pdf.text(
      `Semaine du ${d.toLocaleDateString()} : ${h25.toFixed(2)}h √† 25% / ${h50.toFixed(2)}h √† 50%`,
      10,
      y
    )
    y += 6

    if(y > 270){
      pdf.addPage()
      y = 15
    }
  })

  const reportPrev = getLastValidReport(period.index)
  const brut = total25 * 1.25 + total50 * 1.5 + reportPrev
  const net = brut - totalRecup

  y += 6
  pdf.line(10, y, 200, y)
  y += 8

  pdf.text(`Total 25 % : ${total25.toFixed(2)} h`, 10, y); y+=6
  pdf.text(`Total 50 % : ${total50.toFixed(2)} h`, 10, y); y+=6
  pdf.text(`R√©cup√©rations : ${totalRecup.toFixed(2)} h`, 10, y); y+=6
  pdf.text(`Report pr√©c√©dent : ${reportPrev.toFixed(2)} h`, 10, y); y+=6

  pdf.setFontSize(12)
  pdf.text(`Solde net de p√©riode : ${net.toFixed(2)} h`, 10, y)
  y += 12

  pdf.setFontSize(10)
  pdf.text("Validation / Signature :", 10, y)
  y += 10
  pdf.rect(10, y, 90, 20)

  y += 30
  pdf.setFontSize(8)
  pdf.text(
    "Document g√©n√©r√© automatiquement √† titre informatif.\nNe constitue pas un bulletin de paie.",
    10,
    y
  )

  pdf.save(
    `periode_${period.start.toISOString().slice(0,10)}_${currentSuffix}.pdf`
  )
}
function shouldShowAnnualClosure() {
  if (!annualDate) return false;

  const ad = new Date(annualDate);

  return (
    ad.getFullYear() === viewYear &&
    ad.getMonth() === viewMonth
  );
}
function showToast(){
  const toast = document.getElementById("toast")
  if(!toast) return

  toast.style.opacity = "1"
  setTimeout(() => {
    toast.style.opacity = "0"
  }, 3000)
}
const crashState = localStorage.getItem("APP_CRASH_STATE");
if(crashState){
  console.warn("‚ö†Ô∏è Dernier crash d√©tect√©:", crashState);
}
document.addEventListener("DOMContentLoaded", () => {
  protectFunctions();
  initSelectors();
  applyConfigLock();
  buildPeriods();
  autoSwitchPeriodAtMidnight();
  // Auto-lancement wizard si exercice non configur√©
  if (!exerciseStart) {
    setTimeout(openWizardModal, 300);
  }
});

function openLegalPopup(){
  document.getElementById("popupLegal").style.display = "flex";
}

function closeLegalPopup(){
  document.getElementById("popupLegal").style.display = "none";
}
function protectFunctions(){
  if (!update.__safe) {
    update = safe(update, "update");
    update.__safe = true;
  }
  if (!calculate.__safe) {
    calculate = safe(calculate, "calculate");
    calculate.__safe = true;
  }
  if (!generateCalendar.__safe) {
    generateCalendar = safe(generateCalendar, "calendar");
    generateCalendar.__safe = true;
  }
  if (!buildPeriods.__safe) {
    buildPeriods = safe(buildPeriods, "periods");
    buildPeriods.__safe = true;
  }
  if (!exportJSON.__safe) {
    exportJSON = safe(exportJSON, "exportJSON");
    exportJSON.__safe = true;
  }
  if (!loadJSON.__safe) {
    loadJSON = safe(loadJSON, "importJSON");
    loadJSON.__safe = true;
  }
  if (!exportMonthlyFullPDF.__safe) {
    exportMonthlyFullPDF = safe(exportMonthlyFullPDF, "pdf_month");
    exportMonthlyFullPDF.__safe = true;
  }
  if (!exportAnnualPDF.__safe) {
    exportAnnualPDF = safe(exportAnnualPDF, "pdf_annual");
    exportAnnualPDF.__safe = true;
  }
  if (!exportPeriodPDF.__safe) {
    exportPeriodPDF = safe(exportPeriodPDF, "pdf_period");
    exportPeriodPDF.__safe = true;
  }
}
</script>

<div id="toast" style="
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#323232;
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
">
  üïõ Nouvelle p√©riode activ√©e automatiquement
</div>
<div class="popup" id="popupClosures">
  <div class="popup-content">
    <h3>üìÖ Cl√¥tures comptables</h3>
    <div id="closuresInputs"></div>
    <button onclick="saveClosures()">Enregistrer</button>
    <button onclick="closeClosures()">Fermer</button>
  </div>
</div>

<div style="text-align:center; font-size:12px; color:#666; margin-top:30px;">
 <a href="#" onclick="event.preventDefault(); openLegalPopup();">
    ‚ÑπÔ∏è Informations l√©gales &amp; calcul
  </a>

<a href="#" onclick="event.preventDefault(); openNotice();">
    üìò Notice utilisateur
  </a>

  <button
    type="button"
    onclick="protectedCrash()"
    style="
      margin-left:10px;
      background:none;
      border:none;
      padding:0;
      color:#777;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    "
  >
    ¬© C.Anthony
  </button>
</div>
<p style="
  max-width:900px;
  margin:20px auto;
  font-size:12px;
  color:#555;
  background:#fffde7;
  border:1px solid #ffe082;
  padding:12px;
  border-radius:8px;
  text-align:center;
">
  ‚ö†Ô∏è <b>Sauvegarde des donn√©es</b><br><br>

  Les donn√©es saisies dans cette application sont enregistr√©es
  <b>localement sur cet appareil</b> (navigateur / t√©l√©phone / tablette).<br><br>

  Elles peuvent √™tre perdues en cas de suppression du navigateur,
  de changement d'appareil, de r√©initialisation ou de nettoyage des donn√©es.<br><br>

  <b>Il est fortement recommand√© d'effectuer des exports r√©guliers</b>
  (mensuels ou apr√®s chaque cl√¥ture) afin de conserver une sauvegarde fiable
  de votre suivi annuel.
</p>

<!-- ================================================ -->
<!-- POPUP L√âGAL                                       -->
<!-- ================================================ -->
<div class="popup" id="popupLegal">
  <div class="popup-content" style="max-width:700px;max-height:80vh;overflow:auto;">
    <h3>‚ÑπÔ∏è Informations l√©gales &amp; r√®gles de calcul</h3>

<div class="card" style="font-size:12px;color:#9aa0a6;line-height:1.5">
  <b>‚ö†Ô∏è Responsabilit√© et limites</b><br><br>

  Les donn√©es saisies dans ce simulateur sont renseign√©es
  <b>sous la seule responsabilit√© de l'utilisateur</b>.<br><br>

  Les r√©sultats affich√©s sont fournis √† titre indicatif et peuvent
  ne pas refl√©ter exactement la r√©alit√© du terrain, notamment en raison
  d'erreurs de saisie, de param√®tres incomplets ou inexacts, de diff√©rences
  li√©es √† la convention collective, aux accords d'entreprise, aux pratiques
  internes, d'√©volutions du droit applicable, ou de
  <b>dysfonctionnements techniques, bugs ou limites du simulateur</b>.<br><br>

  Malgr√© le soin apport√© √† sa conception, le simulateur peut contenir
  des erreurs et ne saurait se substituer aux documents officiels,
  outils de l'employeur ou √† l'interpr√©tation des textes l√©gaux.<br><br>

  <b>Seuls les documents √©tablis par l'employeur et le droit applicable
  font foi.</b>
</div>
<p>
Cet outil a pour finalit√© d'aider au suivi, √† l'estimation et √† la compr√©hension
du temps de travail, des heures suppl√©mentaires, des r√©cup√©rations et des soldes
horaires, √† partir des donn√©es saisies par l'utilisateur.
</p>
<hr>
<p>
<b>Fonctionnement g√©n√©ral</b><br><br>
Cet outil fonctionne comme un <b>compteur annuel du temps de travail</b>.<br><br>
Lorsqu'une semaine n'est pas compl√®te (absence ou r√©cup√©ration),
le nombre d'heures attendues est automatiquement ajust√©.<br><br>
Les r√©cup√©rations sont assimil√©es √† du temps non travaill√© et
r√©duisent le volume hebdomadaire de r√©f√©rence dans le cadre
d'un compteur annuel.<br><br>
Les heures suppl√©mentaires ne sont jamais d√©clench√©es avant
d'avoir d√©pass√© l'√©quivalent de <b>35 heures r√©ellement travaill√©es</b>.
</p>
<hr>
<p>
Il s'agit d'un outil d'aide au calcul et √† la lecture des donn√©es, dont les r√©sultats
sont fournis √† titre indicatif. Il ne constitue ni un logiciel de paie, ni un document
officiel, ni un support contractuel.
</p>

<hr>

<h4>‚öñÔ∏è Cadre juridique de r√©f√©rence</h4>

<p>
Les r√®gles de calcul appliqu√©es reposent sur les principes g√©n√©raux du Code du travail
et de la convention collective nationale du commerce de gros (IDCC 573), dans leur
version en vigueur au moment de l'utilisation.
</p>

<p>
Ces r√®gles sont susceptibles d'√©voluer et peuvent √™tre am√©nag√©es par des accords
d'entreprise, des usages internes ou des dispositions contractuelles sp√©cifiques,
qui ne peuvent √™tre int√©gr√©s automatiquement par l'outil.
</p>

<hr>

<h4>üéå Jours f√©ri√©s</h4>

<p>
Lorsqu'un jour f√©ri√© est ch√¥m√© et pay√©, il ouvre droit au maintien de la r√©mun√©ration
lorsque les conditions l√©gales et conventionnelles sont remplies.
</p>

<p>
Un jour f√©ri√© ch√¥m√© et pay√© ne constitue pas du temps de travail effectif. Il n'est
pas assimil√© √† une absence et ne doit pas entra√Æner de p√©nalisation du salari√©.
</p>

<p>
Dans le calcul hebdomadaire, la pr√©sence d'un jour f√©ri√© ch√¥m√© entra√Æne une r√©duction
du temps de travail attendu (par d√©faut 7 heures pour une journ√©e compl√®te), sans
modifier le seuil l√©gal de d√©clenchement des heures suppl√©mentaires.
</p>

<p>
Les heures suppl√©mentaires sont d√©clench√©es uniquement √† partir de la
<b>36·µâ heure r√©ellement travaill√©e</b> dans la semaine, y compris lorsqu'un ou plusieurs
jours f√©ri√©s sont pr√©sents.
</p>

<hr>

<h4>‚ùå Absences</h4>

<p>
Les absences correspondent √† des p√©riodes non travaill√©es imputables au salari√©
(cong√©s sans solde, absences injustifi√©es, absences autoris√©es non assimil√©es √† du
temps de travail effectif, selon les param√®tres saisis).
</p>

<p>
Les absences sont prises en compte uniquement sur les jours ouvr√©s et r√©duisent
le volume d'heures travaillables servant de base au calcul hebdomadaire.
</p>

<p>
Les jours f√©ri√©s ch√¥m√©s et pay√©s ne sont pas comptabilis√©s comme des absences.
</p>

<hr>

<h4>üîÅ R√©cup√©rations</h4>

<p>
Les r√©cup√©rations correspondent √† des heures pr√©c√©demment travaill√©es et ult√©rieurement
non travaill√©es. Elles sont trait√©es comme du temps non travaill√© sur la p√©riode
concern√©e.
</p>

<p>
Les r√©cup√©rations r√©duisent le solde horaire final et peuvent √©galement diminuer
le volume d'heures travaillables dans la semaine selon le param√©trage retenu.
</p>

<hr>

<h4>‚ûï Heures suppl√©mentaires</h4>

<p>
Les heures suppl√©mentaires sont calcul√©es dans une logique de
compteur annuel, √† partir des heures r√©ellement travaill√©es.
</p>

<p>
Le seuil de d√©clenchement correspond √† l'√©quivalent de
35 heures hebdomadaires, ajust√© selon les absences
et les r√©cup√©rations.
</p>

<p>
Les majorations sont calcul√©es selon les seuils l√©gaux en vigueur :
</p>

<ul>
  <li>Heures de la 36·µâ √† la 43·µâ heure : majoration de 25 %</li>
  <li>Heures au-del√† de la 43·µâ heure : majoration de 50 %</li>
</ul>

<p>
Seules les heures r√©ellement travaill√©es sont prises en compte pour le d√©clenchement
des heures suppl√©mentaires.
</p>

<hr>

<h4>‚ö†Ô∏è Limites, param√©trage et responsabilit√©</h4>

<p>
Malgr√© le soin apport√© √† sa conception, cet outil peut comporter des limites,
des erreurs de param√©trage, des impr√©cisions ou des dysfonctionnements techniques,
notamment en cas de donn√©es incompl√®tes, incorrectes ou incoh√©rentes.
</p>

<p>
Il appartient √† l'utilisateur de v√©rifier la coh√©rence des param√®tres saisis
(base hebdomadaire, absences, r√©cup√©rations, jours f√©ri√©s, p√©riodes de cl√¥ture, etc.)
et de contr√¥ler les r√©sultats obtenus.
</p>

<p>
Les r√©sultats affich√©s ne sauraient engager la responsabilit√© de l'√©diteur.
Seuls les documents √©tablis par l'employeur (bulletins de paie, d√©comptes officiels)
et l'interpr√©tation des textes l√©gaux et conventionnels font foi.
</p>

<hr>

<h4>üìö Sources officielles</h4>

<ul>
  <li>
    <a href="https://www.legifrance.gouv.fr/codes/id/LEGITEXT000006072050/"
       target="_blank" rel="noopener">
      Code du travail ‚Äì L√©gifrance
    </a>
  </li>
  <li>
    <a href="https://www.legifrance.gouv.fr/conv_coll/id/KALICONT000005635624"
       target="_blank" rel="noopener">
      Convention collective nationale du commerce de gros (IDCC 573)
    </a>
  </li>
</ul>

<p>
Cet outil ne constitue pas un conseil juridique et ne se substitue pas √† l'analyse
d'un professionnel comp√©tent.
</p>

    <button onclick="closeLegalPopup()">Fermer</button>
  </div>
</div>

<!-- ================================================ -->
<!-- POPUP ANN√âES                                      -->
<!-- ================================================ -->
<div class="popup" id="popupYears">
  <div class="popup-content">
    <h3>üìÅ Exercices existants</h3>
    <div id="yearsList"></div>
    <hr>
    <label>Cr√©er / ouvrir un nouvel exercice</label>
    <input type="number" id="newYearInput" placeholder="Ex : 2039">
    <button onclick="confirmSwitchYear()">Ouvrir</button>
    <button onclick="closeYearsPopup()">Fermer</button>
  </div>
</div>

<!-- ================================================ -->
<!-- MODAL SETTINGS                                    -->
<!-- ================================================ -->
<div class="popup" id="settingsModal">
  <div class="popup-content" style="max-width:600px;max-height:calc(100vh - 40px);overflow-y:auto;">
    <div class="settings-modal-title">
      <h3>‚öôÔ∏è Configuration</h3>
      <button class="settings-close-x" onclick="closeSettingsModal()">‚úï</button>
    </div>

    <!-- Exercice & Calendrier -->
    <div class="settings-group">
      <span class="settings-group-label">üìÖ Exercice &amp; Calendrier</span>
      <label style="font-size:13px;margin-bottom:4px;display:block;">Date de d√©but d'exercice</label>
      <input type="date" id="exerciseStartInput">
      <label style="font-size:13px;margin-top:8px;margin-bottom:4px;display:block;">Date de cl√¥ture annuelle</label>
      <input type="date" id="annualDateInput">
    </div>

    <hr class="settings-divider">

    <!-- Temps de travail -->
    <div class="settings-group">
      <span class="settings-group-label">‚è±Ô∏è Temps de travail</span>
      <label style="font-size:13px;margin-bottom:4px;display:block;">Base hebdomadaire (heures)</label>
      <input type="number" step="0.5" id="baseHebdoInput">
    </div>

    <hr class="settings-divider">

    <!-- Cl√¥tures -->
    <div class="settings-group">
      <span class="settings-group-label">üìÜ Cl√¥tures comptables</span>
      <div class="settings-row">
        <button onclick="openClosures()">üìÖ G√©rer les cl√¥tures</button>
        <select id="periodSelect" style="min-width:0"></select>
      </div>
      <p id="periodInfo" style="font-size:13px;color:#555;margin:6px 0 0;"></p>
      <div id="rateContainer"></div>
    </div>

    <hr class="settings-divider">

    <!-- Jours f√©ri√©s -->
    <div class="settings-group">
      <span class="settings-group-label">üéå Jours f√©ri√©s</span>
      <button onclick="importFeries()">üá´üá∑ Importer jours f√©ri√©s officiels</button>
      <label style="display:flex;align-items:center;gap:8px;margin-top:10px;font-size:14px;cursor:pointer;">
        <input type="checkbox" id="autoFerieToggle" style="width:auto;margin:0;">
        Mode f√©ri√© automatique (‚àí7h en semaine)
      </label>
    </div>

    <hr class="settings-divider">

    <!-- Import / Export -->
    <div class="settings-group">
      <span class="settings-group-label">üíæ Import / Export</span>
      <div class="settings-row">
        <button onclick="importJSON()">‚¨ÜÔ∏è Importer (.json)</button>
        <button onclick="exportJSON()">üíæ Sauvegarder</button>
      </div>
      <div class="settings-row" style="margin-top:8px;">
        <button onclick="exportPeriodPDF()">üìò PDF P√©riode</button>
        <button onclick="exportMonthlyFullPDF()">üìÑ PDF Mensuel</button>
        <button onclick="exportAnnualPDF()">üìï PDF Annuel</button>
      </div>
    </div>

    <hr class="settings-divider">

    <!-- Verrouillage -->
    <div class="settings-group">
      <span class="settings-group-label">üîí S√©curit√©</span>
      <button onclick="toggleConfigLock()">üîí / üîì Verrouiller la configuration</button>
      <p id="configLockInfo" style="font-size:13px;color:#555;margin:6px 0 0;"></p>
    </div>

    <hr class="settings-divider">

    <!-- Assistant -->
    <div class="settings-group">
      <span class="settings-group-label">üßô Assistant de configuration</span>
      <button class="kitsune-btn" style="width:100%;" onclick="restartWizard()">
        üßô Relancer l'assistant de d√©marrage
      </button>
    </div>

    <hr class="settings-divider">

    <!-- Danger zone -->
    <div class="settings-group">
      <span class="settings-group-label" style="color:#c62828;">‚ö†Ô∏è Zone de danger</span>
      <button class="settings-danger-btn" onclick="resetCurrentExercise()">
        ‚ôªÔ∏è R√©initialiser l'exercice en cours
      </button>
    </div>

    <div class="popup-actions">
      <button onclick="closeSettingsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- ================================================ -->
<!-- MODAL WIZARD                                      -->
<!-- ================================================ -->
<div class="popup" id="wizardModal">
  <div class="popup-content" style="max-width:540px;">
    <div class="sheet-handle"></div>

    <!-- Progression -->
    <div class="wiz-progress">
      <div class="wiz-progress-bar" id="wizProgressBar" style="width:20%"></div>
    </div>
    <span class="wiz-step-label" id="wizStepLabel">√âtape 1 / 5</span>

    <!-- √âTAPE 1 : Date de d√©but -->
    <div class="wiz-step wiz-active" id="wizStep1">
      <div class="wiz-question">üìÖ Quelle est la date de d√©but de ton exercice ?</div>
      <p class="wiz-hint">Ex : 01/01/2025 ou le premier lundi de ton exercice comptable.</p>
      <input type="date" id="wizStartDate">
      <div class="wiz-nav">
        <button class="kitsune-btn" onclick="wizGoTo(2)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âTAPE 2 : Cl√¥tures -->
    <div class="wiz-step" id="wizStep2">
      <div class="wiz-question">üìÜ Comment veux-tu d√©finir tes cl√¥tures mensuelles ?</div>
      <div class="wiz-choice-row">
        <div class="wiz-choice-btn" id="wizChoiceAuto" onclick="wizSelectClosureMode('auto')">
          ü§ñ Automatique<br>
          <small style="font-weight:400;color:#999;">Dernier dimanche de chaque mois</small>
        </div>
        <div class="wiz-choice-btn" id="wizChoiceManual" onclick="wizSelectClosureMode('manual')">
          ‚úèÔ∏è Manuel<br>
          <small style="font-weight:400;color:#999;">Je saisis les 12 dates moi-m√™me</small>
        </div>
      </div>
      <!-- Grille saisie manuelle -->
      <div id="wizManualDates" style="display:none;">
        <div class="wiz-closures-grid" id="wizClosuresGrid"></div>
      </div>
      <!-- Info auto -->
      <div id="wizAutoInfo" style="display:none;font-size:13px;color:#2e7d32;background:#e8f5e9;border-radius:8px;padding:10px;margin-bottom:10px;">
        ‚úÖ Les 12 derniers dimanches de chaque mois seront g√©n√©r√©s automatiquement.
      </div>
      <div class="wiz-nav">
        <button onclick="wizGoTo(1)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizGoTo(3)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âTAPE 3 : Cl√¥ture annuelle -->
    <div class="wiz-step" id="wizStep3">
      <div class="wiz-question">üèÅ Date de cl√¥ture annuelle finale ?</div>
      <p class="wiz-hint">Cette date marque la fin de l'exercice. Elle sera automatiquement ramen√©e au dimanche le plus proche.</p>
      <input type="date" id="wizAnnualDate">
      <p id="wizAnnualDateInfo" style="font-size:12px;color:#888;margin-top:4px;"></p>
      <div class="wiz-nav">
        <button onclick="wizGoTo(2)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizGoTo(4)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âTAPE 4 : France -->
    <div class="wiz-step" id="wizStep4">
      <div class="wiz-question">üá´üá∑ Configurer pour la France ?</div>
      <p class="wiz-hint">Ces options sont recommand√©es pour les contrats relevant du droit fran√ßais.</p>
      <label class="wiz-check-row">
        <input type="checkbox" id="wizImportFeries" checked>
        <span>üéå Importer les jours f√©ri√©s officiels (API Gouvernement)</span>
      </label>
      <label class="wiz-check-row">
        <input type="checkbox" id="wizAutoFerie" checked>
        <span>‚öôÔ∏è Mode f√©ri√© automatique : appliquer ‚àí7h les jours f√©ri√©s en semaine</span>
      </label>
      <div class="wiz-nav">
        <button onclick="wizGoTo(3)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizGoTo(5)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âTAPE 5 : Taux horaire + r√©cap -->
    <div class="wiz-step" id="wizStep5">
      <div class="wiz-question">üí∂ Quel est ton taux horaire brut (‚Ç¨) ?</div>
      <p class="wiz-hint">Utilis√© pour estimer le montant des heures suppl√©mentaires lors de la cl√¥ture annuelle.</p>
      <input type="number" id="wizHourlyRate" step="0.5" min="0" value="10" placeholder="Ex : 12.50">

      <div class="wiz-summary" id="wizSummary" style="display:none;margin-top:16px;">
        <b>R√©capitulatif</b><br>
        <span id="wizSummaryContent"></span>
      </div>

      <div class="wiz-nav">
        <button onclick="wizGoTo(4)" style="flex:0 0 auto;width:auto;padding:8px 16px;">‚Üê Retour</button>
        <button class="kitsune-btn" onclick="wizShowSummary()" id="wizSummaryBtn">Voir le r√©capitulatif ‚Üí</button>
        <button class="kitsune-btn" onclick="finishWiz()" id="wizFinishBtn" style="display:none;">
          ‚úÖ Terminer &amp; Lancer
        </button>
      </div>
    </div>

  </div>
</div>

<script>
/* =====================================================
   SETTINGS MODAL
   ===================================================== */
function openSettingsModal() {
  document.getElementById("settingsModal").style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeSettingsModal() {
  document.getElementById("settingsModal").style.display = "none";
  document.body.style.overflow = "";
  if (typeof update === "function") update();
}

document.getElementById("settingsModal").addEventListener("click", function(e) {
  if (e.target === this) closeSettingsModal();
});

document.getElementById("wizardModal").addEventListener("click", function(e) {
  if (e.target === this) closeWizardModal();
});

/* =====================================================
   WIZARD ‚Äî √âTAT GLOBAL
   ===================================================== */
let wizClosureMode  = null;
let wizCurrentStep  = 1;
const WIZ_TOTAL     = 5;

/* =====================================================
   WIZARD ‚Äî NAVIGATION
   ===================================================== */
function wizGoTo(step) {
  if (step > wizCurrentStep && !wizValidate(wizCurrentStep)) return;

  if (step === 5) {
    document.getElementById("wizSummary").style.display    = "none";
    document.getElementById("wizSummaryBtn").style.display = "inline-block";
    document.getElementById("wizFinishBtn").style.display  = "none";
  }

  document.querySelectorAll(".wiz-step").forEach(s => s.classList.remove("wiz-active"));
  document.getElementById("wizStep" + step).classList.add("wiz-active");

  const pct = Math.round((step / WIZ_TOTAL) * 100);
  document.getElementById("wizProgressBar").style.width = pct + "%";
  document.getElementById("wizStepLabel").textContent   = "√âtape " + step + " / " + WIZ_TOTAL;

  wizCurrentStep = step;

  if (step === 2) wizBuildManualGrid();

  if (step === 3) {
    const input = document.getElementById("wizAnnualDate");
    input.onchange = () => {
      const forced = forceSunday(input.value);
      document.getElementById("wizAnnualDateInfo").textContent =
        forced && forced !== input.value
          ? "üìÖ Date ajust√©e au dimanche : " + new Date(forced).toLocaleDateString()
          : "";
      input.value = forced;
    };
  }
}

/* =====================================================
   WIZARD ‚Äî VALIDATION PAR √âTAPE
   ===================================================== */
function wizValidate(step) {
  if (step === 1) {
    if (!document.getElementById("wizStartDate").value) {
      alert("‚ö†Ô∏è Merci de saisir la date de d√©but d'exercice.");
      return false;
    }
  }
  if (step === 2) {
    if (!wizClosureMode) {
      alert("‚ö†Ô∏è Choisis un mode de cl√¥ture.");
      return false;
    }
  }
  return true;
}

/* =====================================================
   WIZARD ‚Äî MODE CL√îTURE
   ===================================================== */
function wizSelectClosureMode(mode) {
  wizClosureMode = mode;
  document.getElementById("wizChoiceAuto").classList.toggle("wiz-selected",   mode === "auto");
  document.getElementById("wizChoiceManual").classList.toggle("wiz-selected", mode === "manual");
  document.getElementById("wizManualDates").style.display = mode === "manual" ? "block" : "none";
  document.getElementById("wizAutoInfo").style.display    = mode === "auto"   ? "block" : "none";
}

/* =====================================================
   WIZARD ‚Äî GRILLE DATES MANUELLES
   ===================================================== */
function wizBuildManualGrid() {
  const grid = document.getElementById("wizClosuresGrid");
  if (grid.children.length > 0) return;

  const startVal = document.getElementById("wizStartDate").value;
  const baseYear = startVal ? new Date(startVal).getFullYear() : new Date().getFullYear();
  const mois = ["Janv.","F√©vr.","Mars","Avr.","Mai","Juin","Juil.","Ao√ªt","Sept.","Oct.","Nov.","D√©c."];

  for (let m = 0; m < 12; m++) {
    const wrap = document.createElement("div");
    const lbl  = document.createElement("label");
    lbl.textContent = mois[m];
    const inp  = document.createElement("input");
    inp.type   = "date";
    inp.id     = "wizManDate_" + m;
    const precomputed = wizLastSunday(baseYear, m);
    if (precomputed) inp.value = precomputed;
    inp.onchange = () => {
      const forced = forceSunday(inp.value);
      if (forced !== inp.value) inp.value = forced;
    };
    wrap.appendChild(lbl);
    wrap.appendChild(inp);
    grid.appendChild(wrap);
  }
}

function wizLastSunday(year, month) {
  const last = new Date(year, month + 1, 0);
  const dow  = last.getDay();
  if (dow === 0) return last.toISOString().slice(0,10);
  last.setDate(last.getDate() - dow);
  return last.toISOString().slice(0,10);
}

/* =====================================================
   WIZARD ‚Äî R√âCAPITULATIF
   ===================================================== */
function wizShowSummary() {
  const startDate  = document.getElementById("wizStartDate").value;
  const annualDateVal = document.getElementById("wizAnnualDate").value;
  const rate       = document.getElementById("wizHourlyRate").value || "‚Äî";
  const feries     = document.getElementById("wizImportFeries").checked ? "Oui" : "Non";
  const autoF      = document.getElementById("wizAutoFerie").checked   ? "Oui" : "Non";
  const clotMode   = wizClosureMode === "auto" ? "Automatique (derniers dimanches)" : "Manuel (12 dates saisies)";

  const start = startDate ? new Date(startDate).toLocaleDateString() : "Non d√©finie";
  const end   = annualDateVal ? new Date(annualDateVal).toLocaleDateString() : "Non d√©finie";

  document.getElementById("wizSummaryContent").innerHTML = `
    üìÖ D√©but d'exercice : <b>${start}</b><br>
    üèÅ Cl√¥ture annuelle : <b>${end}</b><br>
    üìÜ Cl√¥tures : <b>${clotMode}</b><br>
    ‚è±Ô∏è Base hebdomadaire : <b>35 h</b><br>
    üéå Jours f√©ri√©s import√©s : <b>${feries}</b><br>
    ‚öôÔ∏è Mode auto-f√©ri√© : <b>${autoF}</b><br>
    üí∂ Taux horaire : <b>${rate} ‚Ç¨/h</b>
  `;

  document.getElementById("wizSummary").style.display    = "block";
  document.getElementById("wizSummaryBtn").style.display = "none";
  document.getElementById("wizFinishBtn").style.display  = "inline-block";
}

/* =====================================================
   WIZARD ‚Äî FINALISATION
   ===================================================== */
async function finishWiz() {
  const startDate = document.getElementById("wizStartDate").value;
  if (!startDate) { alert("‚ùå Date de d√©but manquante."); return; }

  // 1. Date d√©but
  exerciseStart = startDate;
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);

  // 2. Base fixe 35h
  BASE_HEBDO = 35;
  localStorage.setItem("BASE_HEBDO_" + currentSuffix, 35);

  // 3. Cl√¥tures
  const baseYear = new Date(startDate).getFullYear();
  if (wizClosureMode === "auto") {
    closures = [];
    for (let m = 0; m < 12; m++) {
      closures.push(wizLastSunday(baseYear, m));
    }
  } else {
    closures = [];
    for (let m = 0; m < 12; m++) {
      const v = document.getElementById("wizManDate_" + m)?.value;
      if (v) closures.push(forceSunday(v));
    }
    closures = closures.filter(Boolean).sort();
  }
  localStorage.setItem(STORAGE.closures, JSON.stringify(closures));

  // 4. Cl√¥ture annuelle
  const rawAnnual = document.getElementById("wizAnnualDate").value;
  if (rawAnnual) {
    annualDate = forceSunday(rawAnnual);
    localStorage.setItem(STORAGE.annualDate, annualDate);
  }

  // 5. Taux horaire
  const rate = Number(document.getElementById("wizHourlyRate").value) || 10;
  annualRate  = rate;
  localStorage.setItem("ANNUAL_RATE_" + currentSuffix, rate);

  // 6. Jours f√©ri√©s + mode auto
  const doFeries = document.getElementById("wizImportFeries").checked;
  const doAuto   = document.getElementById("wizAutoFerie").checked;

  AUTO_FERIE = doAuto;
  localStorage.setItem("AUTO_FERIE_" + currentSuffix, doAuto);

  if (doFeries) {
    try {
      const years = [baseYear - 1, baseYear, baseYear + 1];
      for (const y of years) {
        const res    = await fetch(`https://calendrier.api.gouv.fr/jours-feries/metropole/${y}.json`);
        const feries = await res.json();
        Object.keys(feries).forEach(d => { if (!specialDays[d]) specialDays[d] = "ferie"; });
      }
      localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays));
    } catch(e) {
      console.warn("Import jours f√©ri√©s √©chou√© :", e);
    }
  }

  // 7. Fermeture + refresh
  closeWizardModal();
  if (typeof buildPeriods === "function") buildPeriods();
  if (typeof update === "function") update();
  showToast();
}

/* =====================================================
   WIZARD ‚Äî CONTR√îLES OUVERTURE / FERMETURE
   ===================================================== */
function openWizardModal() {
  wizReset();
  document.getElementById("wizardModal").style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeWizardModal() {
  document.getElementById("wizardModal").style.display = "none";
  document.body.style.overflow = "";
}

function restartWizard() {
  closeSettingsModal();
  openWizardModal();
}

function wizReset() {
  wizClosureMode = null;
  wizCurrentStep = 1;

  document.querySelectorAll(".wiz-step").forEach(s => s.classList.remove("wiz-active"));
  document.getElementById("wizStep1").classList.add("wiz-active");
  document.getElementById("wizProgressBar").style.width = "20%";
  document.getElementById("wizStepLabel").textContent   = "√âtape 1 / 5";

  document.getElementById("wizStartDate").value  = exerciseStart || "";
  document.getElementById("wizAnnualDate").value = annualDate    || "";
  document.getElementById("wizAnnualDateInfo").textContent = "";
  document.getElementById("wizHourlyRate").value = annualRate    || 10;
  document.getElementById("wizImportFeries").checked = true;
  document.getElementById("wizAutoFerie").checked    = AUTO_FERIE;
  document.getElementById("wizSummary").style.display    = "none";
  document.getElementById("wizSummaryBtn").style.display = "inline-block";
  document.getElementById("wizFinishBtn").style.display  = "none";

  document.getElementById("wizChoiceAuto").classList.remove("wiz-selected");
  document.getElementById("wizChoiceManual").classList.remove("wiz-selected");
  document.getElementById("wizManualDates").style.display = "none";
  document.getElementById("wizAutoInfo").style.display    = "none";
  document.getElementById("wizClosuresGrid").innerHTML   = "";
}
</script>

<script>
  sessionStorage.setItem("appAlive", "true");
</script>
</body>
</html>
